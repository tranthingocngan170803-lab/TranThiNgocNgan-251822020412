<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>乌龟和兔子 - 汉语拼音学习游戏</title>
    <style>
        /* 全局样式 */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Microsoft YaHei', sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #f0f8ff 0%, #e6f7ff 100%);
            color: #333;
            line-height: 1.6;
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
            min-height: 100vh;
        }
        
        h1, h2, h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            text-shadow: 1px 1px 3px rgba(0,0,0,0.1);
        }
        
        button {
            background: linear-gradient(to bottom, #3498db, #2980b9);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s;
            box-shadow: 0 3px 5px rgba(0,0,0,0.2);
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 8px rgba(0,0,0,0.3);
        }
        
        button:active {
            transform: translateY(1px);
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }
        
        button:disabled {
            background: linear-gradient(to bottom, #95a5a6, #7f8c8d);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        /* 主菜单样式 */
        #main-menu {
            text-align: center;
            padding: 30px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            background: linear-gradient(to bottom right, #ffffff, #f8f9fa);
        }
        
        .menu-options {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 20px;
            margin: 25px 0;
        }
        
        .menu-option {
            flex: 1;
            min-width: 220px;
            padding: 20px;
            background: linear-gradient(145deg, #ecf0f1, #dfe6e9);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            border: 2px solid transparent;
        }
        
        .menu-option:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 15px rgba(0,0,0,0.15);
            border-color: #3498db;
        }
        
        .menu-option.selected {
            background: linear-gradient(145deg, #3498db, #2980b9);
            color: white;
            border-color: #2980b9;
        }
        
        /* 游戏区域样式 */
        #game-area {
            display: none;
            grid-template-columns: 2fr 1fr;
            gap: 25px;
            margin-top: 25px;
        }
        
        @media (max-width: 768px) {
            #game-area {
                grid-template-columns: 1fr;
            }
        }
        
        /* 赛道样式 */
        #race-track {
            background: linear-gradient(to bottom, #2ecc71, #27ae60);
            border-radius: 15px;
            padding: 20px;
            position: relative;
            min-height: 350px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            border: 5px solid #27ae60;
        }
        
        .track-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 8px;
        }
        
        .track-cell {
            background-color: rgba(255, 255, 255, 0.85);
            border-radius: 8px;
            height: 70px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            position: relative;
            font-size: 18px;
            box-shadow: inset 0 0 5px rgba(0,0,0,0.1);
            border: 2px solid #27ae60;
        }
        
        .track-cell.finish {
            background: linear-gradient(45deg, #f1c40f, #e67e22);
            color: white;
            font-size: 24px;
        }
        
        .player {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            position: absolute;
            transition: left 0.5s, top 0.5s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            box-shadow: 0 3px 8px rgba(0,0,0,0.3);
            font-size: 20px;
            z-index: 10;
            border: 3px solid white;
        }
        
        .player-1 { background: linear-gradient(145deg, #e74c3c, #c0392b); } /* 红色兔子 */
        .player-2 { background: linear-gradient(145deg, #3498db, #2980b9); } /* 蓝色乌龟 */
        .player-3 { background: linear-gradient(145deg, #f39c12, #d35400); } /* 橙色兔子 */
        .player-4 { background: linear-gradient(145deg, #9b59b6, #8e44ad); } /* 紫色乌龟 */
        
        /* 控制面板样式 */
        #control-panel {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            background: linear-gradient(to bottom right, #ffffff, #f8f9fa);
            border: 2px solid #ecf0f1;
        }
        
        .player-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
            padding: 12px;
            border-radius: 8px;
            background: linear-gradient(to right, #f8f9fa, #ecf0f1);
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            border-left: 5px solid;
        }
        
        .player-info.active {
            background: linear-gradient(to right, #e3f2fd, #bbdefb);
            box-shadow: 0 3px 8px rgba(33, 150, 243, 0.3);
        }
        
        .progress-bar {
            height: 12px;
            background-color: #ecf0f1;
            border-radius: 6px;
            margin-top: 8px;
            overflow: hidden;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.2);
        }
        
        .progress {
            height: 100%;
            background: linear-gradient(to right, #2ecc71, #27ae60);
            width: 0%;
            transition: width 0.5s;
            border-radius: 6px;
        }
        
        #dice-container {
            text-align: center;
            margin: 25px 0;
            padding: 15px;
            background: linear-gradient(to bottom, #f8f9fa, #ecf0f1);
            border-radius: 12px;
            box-shadow: 0 3px 8px rgba(0,0,0,0.1);
        }
        
        #dice {
            width: 80px;
            height: 80px;
            background: linear-gradient(145deg, #ffffff, #f0f0f0);
            border: 3px solid #3498db;
            border-radius: 15px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            font-weight: bold;
            margin-bottom: 15px;
            box-shadow: 0 5px 10px rgba(0,0,0,0.2);
        }
        
        .dice-rolling {
            animation: roll 0.5s ease-in-out infinite;
        }
        
        @keyframes roll {
            0% { transform: rotate(0deg) scale(1); }
            50% { transform: rotate(180deg) scale(1.1); }
            100% { transform: rotate(360deg) scale(1); }
        }
        
        /* 语音设置样式 */
        #voice-settings {
            margin: 20px 0;
            padding: 15px;
            background: linear-gradient(to bottom, #f8f9fa, #ecf0f1);
            border-radius: 12px;
            box-shadow: 0 3px 8px rgba(0,0,0,0.1);
        }
        
        .setting-group {
            margin-bottom: 15px;
        }
        
        .setting-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #2c3e50;
        }
        
        input[type="range"] {
            width: 100%;
            height: 8px;
            border-radius: 4px;
            background: #dfe6e9;
            outline: none;
        }
        
        select {
            width: 100%;
            padding: 8px;
            border-radius: 5px;
            border: 1px solid #bdc3c7;
            background: white;
        }
        
        /* 题目弹窗样式 */
        #question-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(5px);
        }
        
        #question-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 600px;
            width: 90%;
            text-align: center;
            box-shadow: 0 15px 30px rgba(0,0,0,0.3);
            background: linear-gradient(to bottom right, #ffffff, #f8f9fa);
            border: 3px solid #3498db;
            position: relative;
        }
        
        .question-text {
            font-size: 22px;
            margin-bottom: 20px;
            color: #2c3e50;
            line-height: 1.5;
        }
        
        .options-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin: 25px 0;
        }
        
        @media (max-width: 480px) {
            .options-container {
                grid-template-columns: 1fr;
            }
        }
        
        .option {
            padding: 15px;
            background: linear-gradient(to bottom, #ecf0f1, #dfe6e9);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 18px;
            box-shadow: 0 3px 5px rgba(0,0,0,0.1);
            border: 2px solid transparent;
        }
        
        .option:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 10px rgba(0,0,0,0.2);
            border-color: #3498db;
        }
        
        .option.correct {
            background: linear-gradient(to bottom, #2ecc71, #27ae60);
            color: white;
        }
        
        .option.incorrect {
            background: linear-gradient(to bottom, #e74c3c, #c0392b);
            color: white;
        }
        
        /* 错题本样式 */
        #wrong-answers-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(5px);
        }
        
        #wrong-answers-content {
            background: white;
            padding: 25px;
            border-radius: 15px;
            max-width: 700px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 15px 30px rgba(0,0,0,0.3);
            background: linear-gradient(to bottom right, #ffffff, #f8f9fa);
            border: 3px solid #3498db;
        }
        
        .wrong-answer-item {
            padding: 15px;
            border-bottom: 1px solid #ecf0f1;
            margin-bottom: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        
        /* 难度选择样式 */
        #difficulty-selection {
            display: none;
            text-align: center;
            margin-top: 20px;
        }
        
        .difficulty-option {
            display: inline-block;
            width: 150px;
            padding: 15px;
            margin: 0 10px;
            background: linear-gradient(145deg, #ecf0f1, #dfe6e9);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            border: 2px solid transparent;
        }
        
        .difficulty-option:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 15px rgba(0,0,0,0.15);
        }
        
        .difficulty-option.selected {
            color: white;
            border-color: transparent;
        }
        
        .difficulty-easy.selected {
            background: linear-gradient(145deg, #2ecc71, #27ae60);
        }
        
        .difficulty-medium.selected {
            background: linear-gradient(145deg, #f39c12, #d35400);
        }
        
        .difficulty-hard.selected {
            background: linear-gradient(145deg, #e74c3c, #c0392b);
        }
        
        /* 胜利动画样式 */
        .firework {
            position: absolute;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            pointer-events: none;
            z-index: 20;
        }
        
        @keyframes explode {
            0% { transform: translate(0, 0) scale(1); opacity: 1; }
            100% { transform: translate(var(--tx), var(--ty)) scale(0); opacity: 0; }
        }
        
        /* 响应式调整 */
        @media (max-width: 768px) {
            .menu-options {
                flex-direction: column;
            }
            
            .options-container {
                grid-template-columns: 1fr;
            }
            
            .track-grid {
                grid-template-columns: repeat(5, 1fr);
            }
            
            .difficulty-option {
                display: block;
                width: 100%;
                margin: 10px 0;
            }
        }
        
        /* 游戏标题样式 */
        .game-title {
            text-align: center;
            margin-bottom: 10px;
            color: #2c3e50;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
        }
        
        .game-subtitle {
            text-align: center;
            margin-bottom: 30px;
            color: #7f8c8d;
            font-size: 1.2em;
        }
        
        /* 重新开始确认对话框 */
        #restart-confirm {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(5px);
        }
        
        #restart-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 400px;
            width: 90%;
            text-align: center;
            box-shadow: 0 15px 30px rgba(0,0,0,0.3);
            background: linear-gradient(to bottom right, #ffffff, #f8f9fa);
            border: 3px solid #3498db;
        }
        
        #restart-content h3 {
            color: #e74c3c;
            margin-bottom: 20px;
        }
        
        #restart-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
        }
        
        #confirm-restart {
            background: linear-gradient(to bottom, #e74c3c, #c0392b);
        }
        
        #cancel-restart {
            background: linear-gradient(to bottom, #95a5a6, #7f8c8d);
        }
        
        /* 听力练习按钮样式 */
        #listen-word {
            background: linear-gradient(to bottom, #9b59b6, #8e44ad);
            margin-left: 10px;
        }
        
        .button-group {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <!-- 游戏标题 -->
    <div class="game-title">🐢 乌龟和兔子 🐇</div>
    <div class="game-subtitle">汉语拼音学习游戏 - 通过有趣的赛跑练习汉语拼音和HSK1词汇</div>
    
    <!-- 主菜单 -->
    <div id="main-menu">
        <h2>选择游戏模式</h2>
        
        <div class="menu-options">
            <div class="menu-option" id="mode-human-vs-computer">
                <h3>🤖 人机对战</h3>
                <p>与电脑玩家对战</p>
            </div>
            <div class="menu-option" id="mode-human-vs-human">
                <h3>👥 真人对战</h3>
                <p>与朋友一起玩</p>
            </div>
        </div>
        
        <div id="player-selection" style="display: none;">
            <h3>选择玩家数量</h3>
            <div class="menu-options">
                <div class="menu-option player-count" data-count="2">2 名玩家</div>
                <div class="menu-option player-count" data-count="3">3 名玩家</div>
                <div class="menu-option player-count" data-count="4">4 名玩家</div>
            </div>
        </div>
        
        <div id="computer-selection" style="display: none;">
            <h3>选择电脑玩家数量</h3>
            <div class="menu-options">
                <div class="menu-option computer-count" data-count="1">1 个电脑玩家</div>
                <div class="menu-option computer-count" data-count="2">2 个电脑玩家</div>
                <div class="menu-option computer-count" data-count="3">3 个电脑玩家</div>
            </div>
        </div>
        
        <!-- 难度选择 -->
        <div id="difficulty-selection">
            <h3>选择游戏难度</h3>
            <div style="margin: 20px 0;">
                <div class="difficulty-option difficulty-easy" data-difficulty="easy">
                    <h4>📗 简单</h4>
                    <p>HSK1 简单词汇</p>
                </div>
                <div class="difficulty-option difficulty-medium" data-difficulty="medium">
                    <h4>📘 中等</h4>
                    <p>HSK1 中等词汇</p>
                </div>
                <div class="difficulty-option difficulty-hard" data-difficulty="hard">
                    <h4>📙 困难</h4>
                    <p>HSK1 困难词汇</p>
                </div>
            </div>
        </div>
        
        <button id="start-game" style="display: none; margin-top: 30px; padding: 15px 30px; font-size: 18px;">开始游戏</button>
    </div>
    
    <!-- 游戏区域 -->
    <div id="game-area">
        <!-- 赛道 -->
        <div id="race-track">
            <h2>🏁 赛道</h2>
            <div class="track-grid" id="track-grid">
                <!-- 赛道格子将通过JavaScript动态生成 -->
            </div>
        </div>
        
        <!-- 控制面板 -->
        <div id="control-panel">
            <h2>🎮 游戏控制</h2>
            
            <!-- 玩家信息 -->
            <div id="players-info">
                <!-- 玩家信息将通过JavaScript动态生成 -->
            </div>
            
            <!-- 掷骰子区域 -->
            <div id="dice-container">
                <div id="dice">?</div>
                <button id="roll-dice">掷骰子</button>
            </div>
            
            <!-- 语音设置 -->
            <div id="voice-settings">
                <h3>🔊 语音设置</h3>
                <div class="setting-group">
                    <label for="voice-select">选择语音:</label>
                    <select id="voice-select">
                        <option value="">默认语音</option>
                    </select>
                </div>
                <div class="setting-group">
                    <label for="rate-slider">语速: <span id="rate-value">1</span></label>
                    <input type="range" id="rate-slider" min="0.5" max="2" step="0.1" value="1">
                </div>
                <div class="setting-group">
                    <label for="pitch-slider">音高: <span id="pitch-value">1</span></label>
                    <input type="range" id="pitch-slider" min="0.5" max="2" step="0.1" value="1">
                </div>
                <button id="test-voice">测试语音</button>
            </div>
            
            <!-- 其他控制按钮 -->
            <div style="margin-top: 25px;">
                <button id="view-wrong-answers">📚 查看错题本</button>
                <button id="restart-game">🔄 重新开始</button>
            </div>
        </div>
    </div>
    
    <!-- 题目弹窗 -->
    <div id="question-modal">
        <div id="question-content">
            <h2 id="question-type">题目类型</h2>
            <div class="question-text" id="question-text">题目内容</div>
            <div class="options-container" id="options-container">
                <!-- 选项将通过JavaScript动态生成 -->
            </div>
            <div class="button-group">
                <button id="speak-question">🔊 再次朗读题目</button>
                <button id="listen-word" style="display: none;">🔈 再次听发音</button>
            </div>
        </div>
    </div>
    
    <!-- 错题本弹窗 -->
    <div id="wrong-answers-modal">
        <div id="wrong-answers-content">
            <h2>📚 错题本</h2>
            <div id="wrong-answers-list">
                <!-- 错题将通过JavaScript动态生成 -->
            </div>
            <button id="close-wrong-answers" style="margin-top: 20px;">关闭</button>
        </div>
    </div>
    
    <!-- 重新开始确认对话框 -->
    <div id="restart-confirm">
        <div id="restart-content">
            <h3>⚠️ 重新开始游戏</h3>
            <p>确定要重新开始游戏吗？当前进度将丢失。</p>
            <div id="restart-buttons">
                <button id="confirm-restart">确定</button>
                <button id="cancel-restart">取消</button>
            </div>
        </div>
    </div>

    <script>
        // 游戏状态和配置
        const gameState = {
            currentPlayer: 0,
            players: [],
            totalCells: 36, // 包括起点
            gameMode: null, // 'human-vs-computer' 或 'human-vs-human'
            humanPlayers: 1,
            computerPlayers: 0,
            difficulty: 'easy', // 'easy', 'medium', 'hard'
            isGameActive: false,
            speechSupport: false,
            voices: [],
            currentVoice: null,
            rate: 1,
            pitch: 1,
            questions: [],
            askedQuestions: [], // 跟踪已问过的问题
            wrongAnswers: JSON.parse(localStorage.getItem('wrongAnswers')) || [],
            currentQuestion: null // 存储当前问题
        };

        // 声母定义
        const initials = ['b', 'p', 'm', 'f', 'd', 't', 'n', 'l', 'g', 'k', 'h', 'j', 'q', 'x', 'zh', 'ch', 'sh', 'r', 'z', 'c', 's'];

        // HSK1词汇库 - 分为三个难度级别
        const hsk1Vocabulary = {
            // 简单组
            easy: [
                { word: '你', pinyin: 'nǐ', meaning: 'bạn', type: 'pronoun' },
                { word: '他', pinyin: 'tā', meaning: 'anh ấy', type: 'pronoun' },
                { word: '她', pinyin: 'tā', meaning: 'cô ấy', type: 'pronoun' },
                { word: '是', pinyin: 'shì', meaning: 'là', type: 'verb' },
                { word: '不', pinyin: 'bù', meaning: 'không', type: 'adverb' },
                { word: '好', pinyin: 'hǎo', meaning: 'tốt, khỏe', type: 'adjective' },
                { word: '再见', pinyin: 'zàijiàn', meaning: 'tạm biệt', type: 'phrase' },
                { word: '谢谢', pinyin: 'xièxie', meaning: 'cảm ơn', type: 'phrase' },
                { word: '对不起', pinyin: 'duìbuqǐ', meaning: 'xin lỗi', type: 'phrase' },
                { word: '没关系', pinyin: 'méi guānxi', meaning: 'không sao', type: 'phrase' },
                { word: '请', pinyin: 'qǐng', meaning: 'mời, xin', type: 'verb' },
                { word: '事', pinyin: 'shì', meaning: 'việc, sự việc', type: 'noun' },
                { word: '这', pinyin: 'zhè', meaning: 'đây, này', type: 'pronoun' },
                { word: '那', pinyin: 'nà', meaning: 'kia, đó', type: 'pronoun' },
                { word: '哪', pinyin: 'nǎ', meaning: 'nào, cái nào', type: 'pronoun' },
                { word: '谁', pinyin: 'shéi', meaning: 'ai', type: 'pronoun' },
                { word: '什么', pinyin: 'shénme', meaning: 'cái gì', type: 'pronoun' },
                { word: '怎么', pinyin: 'zěnme', meaning: 'thế nào', type: 'pronoun' },
                { word: '多少', pinyin: 'duōshao', meaning: 'bao nhiêu', type: 'pronoun' },
                { word: '三', pinyin: 'sān', meaning: 'ba', type: 'numeral' },
                { word: '四', pinyin: 'sì', meaning: 'bốn', type: 'numeral' },
                { word: '六', pinyin: 'liù', meaning: 'sáu', type: 'numeral' },
                { word: '七', pinyin: 'qī', meaning: 'bảy', type: 'numeral' },
                { word: '八', pinyin: 'bā', meaning: 'tám', type: 'numeral' },
                { word: '九', pinyin: 'jiǔ', meaning: 'chín', type: 'numeral' },
                { word: '十', pinyin: 'shí', meaning: 'mười', type: 'numeral' }
            ],
            // 中等组
            medium: [
                { word: '中国', pinyin: 'zhōngguó', meaning: 'Trung Quốc', type: 'noun' },
                { word: '北京', pinyin: 'běijīng', meaning: 'Bắc Kinh', type: 'noun' },
                { word: '名字', pinyin: 'míngzi', meaning: 'tên', type: 'noun' },
                { word: '老师', pinyin: 'lǎoshī', meaning: 'thầy/cô giáo', type: 'noun' },
                { word: '学生', pinyin: 'xuésheng', meaning: 'học sinh', type: 'noun' },
                { word: '同学', pinyin: 'tóngxué', meaning: 'bạn học', type: 'noun' },
                { word: '朋友', pinyin: 'péngyou', meaning: 'bạn bè', type: 'noun' },
                { word: '爸爸', pinyin: 'bàba', meaning: 'bố', type: 'noun' },
                { word: '妈妈', pinyin: 'māma', meaning: 'mẹ', type: 'noun' },
                { word: '女儿', pinyin: 'nǚ\'ér', meaning: 'con gái', type: 'noun' },
                { word: '先生', pinyin: 'xiānsheng', meaning: 'ông, ngài', type: 'noun' },
                { word: '小姐', pinyin: 'xiǎojiě', meaning: 'cô (Miss)', type: 'noun' },
                { word: '水', pinyin: 'shuǐ', meaning: 'nước', type: 'noun' },
                { word: '茶', pinyin: 'chá', meaning: 'trà', type: 'noun' },
                { word: '米饭', pinyin: 'mǐfàn', meaning: 'cơm', type: 'noun' },
                { word: '菜', pinyin: 'cài', meaning: 'món ăn', type: 'noun' },
                { word: '苹果', pinyin: 'píngguǒ', meaning: 'táo', type: 'noun' },
                { word: '商店', pinyin: 'shāngdiàn', meaning: 'cửa hàng', type: 'noun' },
                { word: '学校', pinyin: 'xuéxiào', meaning: 'trường học', type: 'noun' },
                { word: '火车站', pinyin: 'huǒchēzhàn', meaning: 'ga tàu', type: 'noun' },
                { word: '汉语', pinyin: 'hànyǔ', meaning: 'tiếng Hán', type: 'noun' },
                { word: '字', pinyin: 'zì', meaning: 'chữ', type: 'noun' },
                { word: '书', pinyin: 'shū', meaning: 'sách', type: 'noun' },
                { word: '杯子', pinyin: 'bēizi', meaning: 'cốc', type: 'noun' },
                { word: '桌子', pinyin: 'zhuōzi', meaning: 'bàn', type: 'noun' },
                { word: '钱', pinyin: 'qián', meaning: 'tiền', type: 'noun' },
                { word: '东西', pinyin: 'dōngxi', meaning: 'đồ vật', type: 'noun' },
                { word: '日', pinyin: 'rì', meaning: 'ngày, mặt trời', type: 'noun' },
                { word: '年', pinyin: 'nián', meaning: 'năm', type: 'noun' }
            ],
            // 困难组
            hard: [
                { word: '上午', pinyin: 'shàngwǔ', meaning: 'buổi sáng', type: 'noun' },
                { word: '中午', pinyin: 'zhōngwǔ', meaning: 'buổi trưa', type: 'noun' },
                { word: '下午', pinyin: 'xiàwǔ', meaning: 'buổi chiều', type: 'noun' },
                { word: '今天', pinyin: 'jīntiān', meaning: 'hôm nay', type: 'noun' },
                { word: '明天', pinyin: 'míngtiān', meaning: 'ngày mai', type: 'noun' },
                { word: '昨天', pinyin: 'zuótiān', meaning: 'hôm qua', type: 'noun' },
                { word: '现在', pinyin: 'xiànzài', meaning: 'bây giờ', type: 'noun' },
                { word: '时候', pinyin: 'shíhou', meaning: 'lúc, khi', type: 'noun' },
                { word: '点', pinyin: 'diǎn', meaning: 'giờ', type: 'noun' },
                { word: '分钟', pinyin: 'fēnzhōng', meaning: 'phút', type: 'noun' },
                { word: '先生', pinyin: 'xiānsheng', meaning: 'ông (cách gọi trang trọng)', type: 'noun' },
                { word: '工作', pinyin: 'gōngzuò', meaning: 'công việc', type: 'noun/verb' },
                { word: '学习', pinyin: 'xuéxí', meaning: 'học tập', type: 'verb' },
                { word: '住', pinyin: 'zhù', meaning: 'sống, ở', type: 'verb' },
                { word: '坐', pinyin: 'zuò', meaning: 'ngồi', type: 'verb' },
                { word: '读', pinyin: 'dú', meaning: 'đọc', type: 'verb' },
                { word: '写', pinyin: 'xiě', meaning: 'viết', type: 'verb' },
                { word: '看', pinyin: 'kàn', meaning: 'nhìn, xem', type: 'verb' },
                { word: '听', pinyin: 'tīng', meaning: 'nghe', type: 'verb' },
                { word: '说话', pinyin: 'shuōhuà', meaning: 'nói chuyện', type: 'verb' },
                { word: '打电话', pinyin: 'dǎ diànhuà', meaning: 'gọi điện thoại', type: 'verb' },
                { word: '看见', pinyin: 'kànjiàn', meaning: 'nhìn thấy', type: 'verb' },
                { word: '喜欢', pinyin: 'xǐhuan', meaning: 'thích', type: 'verb' },
                { word: '想', pinyin: 'xiǎng', meaning: 'nghĩ, muốn', type: 'verb' },
                { word: '做', pinyin: 'zuò', meaning: 'làm', type: 'verb' },
                { word: '买', pinyin: 'mǎi', meaning: 'mua', type: 'verb' },
                { word: '开', pinyin: 'kāi', meaning: 'mở, lái (xe)', type: 'verb' },
                { word: '回', pinyin: 'huí', meaning: 'trở về', type: 'verb' },
                { word: '去', pinyin: 'qù', meaning: 'đi', type: 'verb' },
                { word: '来', pinyin: 'lái', meaning: 'đến', type: 'verb' },
                { word: '给', pinyin: 'gěi', meaning: 'cho', type: 'verb' },
                { word: '在', pinyin: 'zài', meaning: 'ở, tại', type: 'verb/preposition' }
            ]
        };

        // 初始化游戏
        document.addEventListener('DOMContentLoaded', function() {
            initializeGame();
            setupEventListeners();
            initializeSpeech();
        });

        // 初始化游戏
        function initializeGame() {
            createTrack();
            updatePlayersInfo();
        }

        // 设置事件监听器
        function setupEventListeners() {
            // 游戏模式选择
            document.getElementById('mode-human-vs-computer').addEventListener('click', function() {
                selectGameMode('human-vs-computer');
            });
            
            document.getElementById('mode-human-vs-human').addEventListener('click', function() {
                selectGameMode('human-vs-human');
            });
            
            // 玩家数量选择
            document.querySelectorAll('.player-count').forEach(option => {
                option.addEventListener('click', function() {
                    document.querySelectorAll('.player-count').forEach(o => o.classList.remove('selected'));
                    this.classList.add('selected');
                    gameState.humanPlayers = parseInt(this.getAttribute('data-count'));
                    showDifficultySelection();
                });
            });
            
            // 电脑玩家数量选择
            document.querySelectorAll('.computer-count').forEach(option => {
                option.addEventListener('click', function() {
                    document.querySelectorAll('.computer-count').forEach(o => o.classList.remove('selected'));
                    this.classList.add('selected');
                    gameState.computerPlayers = parseInt(this.getAttribute('data-count'));
                    showDifficultySelection();
                });
            });
            
            // 难度选择
            document.querySelectorAll('.difficulty-option').forEach(option => {
                option.addEventListener('click', function() {
                    document.querySelectorAll('.difficulty-option').forEach(o => o.classList.remove('selected'));
                    this.classList.add('selected');
                    gameState.difficulty = this.getAttribute('data-difficulty');
                    document.getElementById('start-game').style.display = 'inline-block';
                });
            });
            
            // 开始游戏按钮
            document.getElementById('start-game').addEventListener('click', startGame);
            
            // 掷骰子按钮
            document.getElementById('roll-dice').addEventListener('click', rollDice);
            
            // 语音设置
            document.getElementById('rate-slider').addEventListener('input', function() {
                document.getElementById('rate-value').textContent = this.value;
                gameState.rate = parseFloat(this.value);
            });
            
            document.getElementById('pitch-slider').addEventListener('input', function() {
                document.getElementById('pitch-value').textContent = this.value;
                gameState.pitch = parseFloat(this.value);
            });
            
            document.getElementById('voice-select').addEventListener('change', function() {
                const voiceIndex = this.selectedIndex - 1; // 减去默认选项
                if (voiceIndex >= 0 && voiceIndex < gameState.voices.length) {
                    gameState.currentVoice = gameState.voices[voiceIndex];
                } else {
                    gameState.currentVoice = null;
                }
            });
            
            document.getElementById('test-voice').addEventListener('click', function() {
                speakText('这是一个语音测试。乌龟和兔子汉语拼音学习游戏。');
            });
            
            // 错题本按钮
            document.getElementById('view-wrong-answers').addEventListener('click', showWrongAnswers);
            document.getElementById('close-wrong-answers').addEventListener('click', function() {
                document.getElementById('wrong-answers-modal').style.display = 'none';
            });
            
            // 重新开始按钮
            document.getElementById('restart-game').addEventListener('click', function() {
                document.getElementById('restart-confirm').style.display = 'flex';
            });
            
            document.getElementById('confirm-restart').addEventListener('click', function() {
                document.getElementById('restart-confirm').style.display = 'none';
                restartGame();
            });
            
            document.getElementById('cancel-restart').addEventListener('click', function() {
                document.getElementById('restart-confirm').style.display = 'none';
            });
            
            // 语音按钮
            document.getElementById('speak-question').addEventListener('click', function() {
                if (gameState.currentQuestion) {
                    speakQuestion(gameState.currentQuestion);
                }
            });
            
            document.getElementById('listen-word').addEventListener('click', function() {
                if (gameState.currentQuestion && gameState.currentQuestion.type === 'listening') {
                    speakText(gameState.currentQuestion.word);
                }
            });
        }

        // 选择游戏模式
        function selectGameMode(mode) {
            gameState.gameMode = mode;
            
            // 更新UI
            document.querySelectorAll('.menu-option').forEach(option => {
                option.classList.remove('selected');
            });
            
            if (mode === 'human-vs-computer') {
                document.getElementById('mode-human-vs-computer').classList.add('selected');
                document.getElementById('player-selection').style.display = 'none';
                document.getElementById('computer-selection').style.display = 'block';
                
                // 默认选择1个电脑玩家
                document.querySelector('.computer-count[data-count="1"]').click();
            } else {
                document.getElementById('mode-human-vs-human').classList.add('selected');
                document.getElementById('player-selection').style.display = 'block';
                document.getElementById('computer-selection').style.display = 'none';
                
                // 默认选择2名玩家
                document.querySelector('.player-count[data-count="2"]').click();
            }
        }

        // 显示难度选择
        function showDifficultySelection() {
            document.getElementById('difficulty-selection').style.display = 'block';
            
            // 默认选择简单难度
            document.querySelector('.difficulty-option[data-difficulty="easy"]').click();
        }

        // 开始游戏
        function startGame() {
            // 隐藏主菜单，显示游戏区域
            document.getElementById('main-menu').style.display = 'none';
            document.getElementById('game-area').style.display = 'grid';
            
            // 初始化玩家
            initializePlayers();
            
            // 创建赛道
            createTrack();
            
            // 更新玩家信息
            updatePlayersInfo();
            
            // 设置游戏状态
            gameState.isGameActive = true;
            gameState.currentPlayer = 0;
            
            // 初始化问题库
            initializeQuestions();
            
            // 如果是电脑玩家且当前轮到电脑，自动掷骰子
            if (gameState.players[gameState.currentPlayer].isComputer) {
                setTimeout(() => {
                    rollDice();
                }, 1000);
            }
        }

        // 初始化玩家
        function initializePlayers() {
            gameState.players = [];
            
            // 根据游戏模式添加玩家
            if (gameState.gameMode === 'human-vs-computer') {
                // 添加人类玩家
                gameState.players.push({
                    id: 1,
                    name: '玩家 1',
                    position: 0,
                    isComputer: false,
                    color: 'player-1'
                });
                
                // 添加电脑玩家
                for (let i = 1; i <= gameState.computerPlayers; i++) {
                    gameState.players.push({
                        id: i + 1,
                        name: `电脑 ${i}`,
                        position: 0,
                        isComputer: true,
                        color: `player-${i + 1}`
                    });
                }
            } else {
                // 添加人类玩家
                for (let i = 1; i <= gameState.humanPlayers; i++) {
                    gameState.players.push({
                        id: i,
                        name: `玩家 ${i}`,
                        position: 0,
                        isComputer: false,
                        color: `player-${i}`
                    });
                }
            }
        }

        // 创建赛道
        function createTrack() {
            const trackGrid = document.getElementById('track-grid');
            trackGrid.innerHTML = '';
            
            // 创建起点格子
            const startCell = document.createElement('div');
            startCell.className = 'track-cell';
            startCell.id = `cell-0`;
            startCell.textContent = '起点';
            trackGrid.appendChild(startCell);
            
            // 创建赛道格子（从1开始）
            for (let i = 1; i < gameState.totalCells; i++) {
                const cell = document.createElement('div');
                cell.className = 'track-cell';
                cell.id = `cell-${i}`;
                
                // 最后一个格子是终点
                if (i === gameState.totalCells - 1) {
                    cell.classList.add('finish');
                    cell.textContent = '🏁';
                } else {
                    cell.textContent = i;
                }
                
                trackGrid.appendChild(cell);
            }
            
            // 放置玩家到起点
            placePlayersOnTrack();
        }

        // 放置玩家到赛道上
        function placePlayersOnTrack() {
            // 清除之前的玩家
            document.querySelectorAll('.player').forEach(player => player.remove());
            
            // 放置每个玩家
            gameState.players.forEach((player, index) => {
                const playerElement = document.createElement('div');
                playerElement.className = `player ${player.color}`;
                playerElement.id = `player-${player.id}`;
                playerElement.textContent = player.id;
                
                // 将玩家放置在起点
                const startCell = document.getElementById('cell-0');
                const rect = startCell.getBoundingClientRect();
                const trackRect = document.getElementById('race-track').getBoundingClientRect();
                
                // 计算玩家在格子中的位置（分散放置）
                const offsetX = (index % 3) * 15 - 15;
                const offsetY = Math.floor(index / 3) * 15 - 15;
                
                playerElement.style.left = `${rect.left - trackRect.left + offsetX}px`;
                playerElement.style.top = `${rect.top - trackRect.top + offsetY}px`;
                
                document.getElementById('race-track').appendChild(playerElement);
            });
        }

        // 更新玩家信息
        function updatePlayersInfo() {
            const playersInfo = document.getElementById('players-info');
            playersInfo.innerHTML = '';
            
            gameState.players.forEach((player, index) => {
                const playerInfo = document.createElement('div');
                playerInfo.className = `player-info ${index === gameState.currentPlayer ? 'active' : ''}`;
                playerInfo.style.borderLeftColor = getPlayerColor(player.color);
                
                playerInfo.innerHTML = `
                    <div>
                        <strong>${player.name}</strong>
                        <div class="progress-bar">
                            <div class="progress" style="width: ${(player.position / (gameState.totalCells - 1)) * 100}%"></div>
                        </div>
                    </div>
                    <div>位置: ${player.position === 0 ? '起点' : player.position}</div>
                `;
                
                playersInfo.appendChild(playerInfo);
            });
        }

        // 获取玩家颜色
        function getPlayerColor(colorClass) {
            const colorMap = {
                'player-1': '#e74c3c',
                'player-2': '#3498db',
                'player-3': '#f39c12',
                'player-4': '#9b59b6'
            };
            
            return colorMap[colorClass] || '#3498db';
        }

        // 掷骰子
        function rollDice() {
            if (!gameState.isGameActive) return;
            
            const dice = document.getElementById('dice');
            const rollButton = document.getElementById('roll-dice');
            
            // 禁用掷骰子按钮
            rollButton.disabled = true;
            
            // 骰子滚动动画
            dice.classList.add('dice-rolling');
            dice.textContent = '?';
            
            // 模拟骰子滚动
            let rollCount = 0;
            const maxRolls = 10;
            const rollInterval = setInterval(() => {
                dice.textContent = Math.floor(Math.random() * 6) + 1;
                rollCount++;
                
                if (rollCount >= maxRolls) {
                    clearInterval(rollInterval);
                    
                    // 确定最终点数
                    const rollValue = Math.floor(Math.random() * 6) + 1;
                    dice.textContent = rollValue;
                    dice.classList.remove('dice-rolling');
                    
                    // 移动玩家
                    setTimeout(() => {
                        movePlayer(rollValue);
                    }, 500);
                }
            }, 100);
        }

        // 移动玩家
        function movePlayer(steps) {
            const currentPlayer = gameState.players[gameState.currentPlayer];
            const newPosition = Math.min(currentPlayer.position + steps, gameState.totalCells - 1);
            
            // 更新玩家位置
            currentPlayer.position = newPosition;
            
            // 移动玩家图标
            const playerElement = document.getElementById(`player-${currentPlayer.id}`);
            const targetCell = document.getElementById(`cell-${newPosition}`);
            const trackRect = document.getElementById('race-track').getBoundingClientRect();
            const cellRect = targetCell.getBoundingClientRect();
            
            playerElement.style.left = `${cellRect.left - trackRect.left}px`;
            playerElement.style.top = `${cellRect.top - trackRect.top}px`;
            
            // 更新玩家信息
            updatePlayersInfo();
            
            // 检查是否到达终点
            if (newPosition === gameState.totalCells - 1) {
                endGame(currentPlayer);
                return;
            }
            
            // 显示问题（只有当玩家不在起点时才显示问题）
            if (newPosition > 0) {
                setTimeout(() => {
                    showQuestion();
                }, 1000);
            } else {
                // 如果回到起点，直接进入下一回合
                setTimeout(() => {
                    nextTurn();
                }, 1000);
            }
        }

        // 初始化问题库
        function initializeQuestions() {
            // 清空已问问题列表
            gameState.askedQuestions = [];
            
            // 根据难度选择词汇
            const vocabulary = hsk1Vocabulary[gameState.difficulty];
            
            // 生成问题
            gameState.questions = [];
            
            vocabulary.forEach(word => {
                // 声母问题
                gameState.questions.push({
                    type: 'initial',
                    word: word.word,
                    pinyin: word.pinyin,
                    meaning: word.meaning,
                    question: word.word.split('').length > 1 ? 
                        `"${word.word}"的第一个字声母是什么？` : 
                        `"${word.word}"的声母是什么？`,
                    options: generateInitialOptions(word.pinyin),
                    correctAnswer: getInitial(word.pinyin)
                });
                
                // 拼音问题
                gameState.questions.push({
                    type: 'pinyin',
                    word: word.word,
                    pinyin: word.pinyin,
                    meaning: word.meaning,
                    question: `"${word.word}"的正确拼音是什么？`,
                    options: generatePinyinOptions(word.pinyin),
                    correctAnswer: word.pinyin
                });
                
                // 词义问题
                gameState.questions.push({
                    type: 'meaning',
                    word: word.word,
                    pinyin: word.pinyin,
                    meaning: word.meaning,
                    question: `"${word.word}"的越南语是什么意思？`,
                    options: generateMeaningOptions(word.meaning),
                    correctAnswer: word.meaning
                });
                
                // 听力问题
                gameState.questions.push({
                    type: 'listening',
                    word: word.word,
                    pinyin: word.pinyin,
                    meaning: word.meaning,
                    question: `请听发音，选择正确的答案`,
                    options: generateListeningOptions(word.word, vocabulary),
                    correctAnswer: word.word
                });
            });
        }

        // 获取声母
        function getInitial(pinyin) {
            // 处理多音节词的第一个音节
            const firstSyllable = pinyin.replace(/[āáǎàēéěèīíǐìōóǒòūúǔùǖǘǚǜ]/g, '').split('')[0];
            
            // 检查是否是复合声母 (zh, ch, sh)
            if (pinyin.startsWith('zh') || pinyin.startsWith('ch') || pinyin.startsWith('sh')) {
                return pinyin.substring(0, 2);
            }
            
            return firstSyllable;
        }

        // 生成声母选项
        function generateInitialOptions(correctPinyin) {
            const correctInitial = getInitial(correctPinyin);
            const options = [correctInitial];
            
            // 添加混淆选项
            while (options.length < 4) {
                const randomInitial = initials[Math.floor(Math.random() * initials.length)];
                if (!options.includes(randomInitial) && randomInitial !== correctInitial) {
                    // 确保混淆选项与正确答案相似（例如z和zh）
                    if ((correctInitial === 'z' && randomInitial === 'zh') || 
                        (correctInitial === 'zh' && randomInitial === 'z') ||
                        (correctInitial === 'c' && randomInitial === 'ch') ||
                        (correctInitial === 'ch' && randomInitial === 'c') ||
                        (correctInitial === 's' && randomInitial === 'sh') ||
                        (correctInitial === 'sh' && randomInitial === 's') ||
                        Math.random() < 0.7) { // 70%的概率添加相似选项
                        options.push(randomInitial);
                    }
                }
            }
            
            // 随机排序选项
            return shuffleArray(options);
        }

        // 生成拼音选项
        function generatePinyinOptions(correctPinyin) {
            const options = [correctPinyin];
            
            // 添加混淆选项
            while (options.length < 4) {
                // 从同一难度级别的词汇中随机选择拼音
                const vocabulary = hsk1Vocabulary[gameState.difficulty];
                const randomWord = vocabulary[Math.floor(Math.random() * vocabulary.length)];
                const randomPinyin = randomWord.pinyin;
                
                if (!options.includes(randomPinyin) && randomPinyin !== correctPinyin) {
                    options.push(randomPinyin);
                }
            }
            
            // 随机排序选项
            return shuffleArray(options);
        }

        // 生成词义选项
        function generateMeaningOptions(correctMeaning) {
            const options = [correctMeaning];
            
            // 添加混淆选项
            while (options.length < 4) {
                // 从同一难度级别的词汇中随机选择词义
                const vocabulary = hsk1Vocabulary[gameState.difficulty];
                const randomWord = vocabulary[Math.floor(Math.random() * vocabulary.length)];
                const randomMeaning = randomWord.meaning;
                
                if (!options.includes(randomMeaning) && randomMeaning !== correctMeaning) {
                    options.push(randomMeaning);
                }
            }
            
            // 随机排序选项
            return shuffleArray(options);
        }

        // 生成听力选项
        function generateListeningOptions(correctWord, vocabulary) {
            const options = [correctWord];
            
            // 添加混淆选项
            while (options.length < 4) {
                const randomWord = vocabulary[Math.floor(Math.random() * vocabulary.length)];
                const randomWordText = randomWord.word;
                
                if (!options.includes(randomWordText) && randomWordText !== correctWord) {
                    options.push(randomWordText);
                }
            }
            
            // 随机排序选项
            return shuffleArray(options);
        }

        // 随机打乱数组
        function shuffleArray(array) {
            const newArray = [...array];
            for (let i = newArray.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
            }
            return newArray;
        }

        // 显示问题
        function showQuestion() {
            // 从问题库中选择一个未问过的问题
            let availableQuestions = gameState.questions.filter(q => 
                !gameState.askedQuestions.includes(`${q.type}-${q.word}`)
            );
            
            // 如果所有问题都已问过，重置已问问题列表
            if (availableQuestions.length === 0) {
                gameState.askedQuestions = [];
                availableQuestions = gameState.questions;
            }
            
            // 随机选择一个问
            const randomIndex = Math.floor(Math.random() * availableQuestions.length);
            const question = availableQuestions[randomIndex];
            
            // 记录已问问题
            gameState.askedQuestions.push(`${question.type}-${question.word}`);
            
            // 存储当前问题
            gameState.currentQuestion = question;
            
            // 更新问题弹窗内容
            document.getElementById('question-type').textContent = getQuestionTypeText(question.type);
            document.getElementById('question-text').textContent = question.question;
            
            // 生成选项
            const optionsContainer = document.getElementById('options-container');
            optionsContainer.innerHTML = '';
            
            question.options.forEach((option, index) => {
                const optionElement = document.createElement('div');
                optionElement.className = 'option';
                optionElement.textContent = `${String.fromCharCode(65 + index)}. ${option}`;
                optionElement.dataset.value = option;
                
                optionElement.addEventListener('click', function() {
                    checkAnswer(option, question);
                });
                
                optionsContainer.appendChild(optionElement);
            });
            
            // 显示/隐藏听力按钮
            const listenButton = document.getElementById('listen-word');
            if (question.type === 'listening') {
                listenButton.style.display = 'inline-block';
                // 自动播放单词发音
                setTimeout(() => {
                    speakText(question.word);
                }, 500);
            } else {
                listenButton.style.display = 'none';
            }
            
            // 显示问题弹窗
            document.getElementById('question-modal').style.display = 'flex';
            
            // 朗读题目
            speakQuestion(question);
            
            // 如果是电脑玩家，自动选择答案
            if (gameState.players[gameState.currentPlayer].isComputer) {
                setTimeout(() => {
                    // 电脑有80%的概率答对
                    const isCorrect = Math.random() < 0.8;
                    let selectedOption;
                    
                    if (isCorrect) {
                        selectedOption = question.correctAnswer;
                    } else {
                        // 选择一个错误答案
                        const wrongOptions = question.options.filter(opt => opt !== question.correctAnswer);
                        selectedOption = wrongOptions[Math.floor(Math.random() * wrongOptions.length)];
                    }
                    
                    // 模拟点击选项
                    const optionElements = document.querySelectorAll('.option');
                    optionElements.forEach(opt => {
                        if (opt.dataset.value === selectedOption) {
                            opt.click();
                        }
                    });
                }, 2000);
            }
        }

        // 获取问题类型文本
        function getQuestionTypeText(type) {
            const typeMap = {
                'initial': '声母问题',
                'pinyin': '拼音问题',
                'meaning': '词义问题',
                'listening': '听力练习'
            };
            
            return typeMap[type] || '问题';
        }

        // 朗读问题
        function speakQuestion(question) {
            let textToSpeak = question.question;
            
            if (question.type === 'listening') {
                // 对于听力问题，先读问题，然后读单词
                speakText(textToSpeak);
                setTimeout(() => {
                    speakText(question.word);
                }, 1500);
            } else {
                speakText(textToSpeak);
            }
        }

        // 检查答案
        function checkAnswer(selectedOption, question) {
            const isCorrect = selectedOption === question.correctAnswer;
            const optionElements = document.querySelectorAll('.option');
            const currentPlayer = gameState.players[gameState.currentPlayer];
            
            // 标记正确和错误答案
            optionElements.forEach(opt => {
                if (opt.dataset.value === question.correctAnswer) {
                    opt.classList.add('correct');
                } else if (opt.dataset.value === selectedOption && !isCorrect) {
                    opt.classList.add('incorrect');
                }
                
                // 禁用所有选项
                opt.style.pointerEvents = 'none';
            });
            
            // 处理错误答案
            if (!isCorrect) {
                // 记录错误答案
                gameState.wrongAnswers.push({
                    question: question.question,
                    correctAnswer: question.correctAnswer,
                    playerAnswer: selectedOption,
                    word: question.word,
                    pinyin: question.pinyin,
                    meaning: question.meaning,
                    type: question.type,
                    timestamp: new Date().toLocaleString()
                });
                
                // 保存到本地存储
                localStorage.setItem('wrongAnswers', JSON.stringify(gameState.wrongAnswers));
                
                // 将玩家位置重置为0（返回起点）
                currentPlayer.position = 0;
                
                // 移动玩家图标回起点
                const playerElement = document.getElementById(`player-${currentPlayer.id}`);
                const startCell = document.getElementById(`cell-0`);
                const trackRect = document.getElementById('race-track').getBoundingClientRect();
                const cellRect = startCell.getBoundingClientRect();
                
                playerElement.style.left = `${cellRect.left - trackRect.left}px`;
                playerElement.style.top = `${cellRect.top - trackRect.top}px`;
                
                // 更新玩家信息
                updatePlayersInfo();
            }
            
            // 朗读确认
            speakText(isCorrect ? "答案正确！" : "答案错误！");
            
            // 关闭问题弹窗并继续游戏
            setTimeout(() => {
                document.getElementById('question-modal').style.display = 'none';
                nextTurn();
            }, 2000);
        }

        // 下一回合
        function nextTurn() {
            // 切换到下一个玩家
            gameState.currentPlayer = (gameState.currentPlayer + 1) % gameState.players.length;
            updatePlayersInfo();
            
            // 启用掷骰子按钮（如果当前是人类玩家）
            const currentPlayer = gameState.players[gameState.currentPlayer];
            const rollButton = document.getElementById('roll-dice');
            
            if (currentPlayer.isComputer) {
                rollButton.disabled = true;
                
                // 电脑玩家自动掷骰子
                setTimeout(() => {
                    rollDice();
                }, 1000);
            } else {
                rollButton.disabled = false;
            }
        }

        // 结束游戏
        function endGame(winner) {
            gameState.isGameActive = false;
            
            // 显示胜利消息
            speakText(`恭喜 ${winner.name} 赢得了比赛！`);
            
            // 创建胜利动画
            createFireworks();
            
            // 显示重新开始按钮
            setTimeout(() => {
                alert(`${winner.name} 赢得了比赛！`);
                restartGame();
            }, 3000);
        }

        // 创建胜利动画
        function createFireworks() {
            const track = document.getElementById('race-track');
            
            for (let i = 0; i < 50; i++) {
                setTimeout(() => {
                    const firework = document.createElement('div');
                    firework.className = 'firework';
                    firework.style.left = `${Math.random() * 100}%`;
                    firework.style.top = `${Math.random() * 100}%`;
                    firework.style.backgroundColor = getRandomColor();
                    
                    // 随机运动方向
                    const tx = (Math.random() - 0.5) * 200;
                    const ty = (Math.random() - 0.5) * 200;
                    firework.style.setProperty('--tx', `${tx}px`);
                    firework.style.setProperty('--ty', `${ty}px`);
                    
                    firework.style.animation = `explode 1s forwards`;
                    
                    track.appendChild(firework);
                    
                    // 移除动画元素
                    setTimeout(() => {
                        firework.remove();
                    }, 1000);
                }, i * 100);
            }
        }

        // 获取随机颜色
        function getRandomColor() {
            const colors = ['#e74c3c', '#3498db', '#f39c12', '#2ecc71', '#9b59b6', '#1abc9c'];
            return colors[Math.floor(Math.random() * colors.length)];
        }

        // 重新开始游戏
        function restartGame() {
            // 重置游戏状态
            gameState.currentPlayer = 0;
            gameState.players.forEach(player => {
                player.position = 0;
            });
            gameState.isGameActive = true;
            gameState.askedQuestions = [];
            
            // 重置UI
            document.getElementById('main-menu').style.display = 'block';
            document.getElementById('game-area').style.display = 'none';
            document.getElementById('player-selection').style.display = 'none';
            document.getElementById('computer-selection').style.display = 'none';
            document.getElementById('difficulty-selection').style.display = 'none';
            document.getElementById('start-game').style.display = 'none';
            
            // 重置赛道和玩家位置
            createTrack();
            updatePlayersInfo();
            
            // 启用掷骰子按钮
            document.getElementById('roll-dice').disabled = false;
        }

        // 显示错题本
        function showWrongAnswers() {
            const wrongAnswersList = document.getElementById('wrong-answers-list');
            wrongAnswersList.innerHTML = '';
            
            if (gameState.wrongAnswers.length === 0) {
                wrongAnswersList.innerHTML = '<p>还没有错题记录。</p>';
            } else {
                gameState.wrongAnswers.forEach((item, index) => {
                    const wrongAnswerItem = document.createElement('div');
                    wrongAnswerItem.className = 'wrong-answer-item';
                    
                    wrongAnswerItem.innerHTML = `
                        <h4>${item.question}</h4>
                        <p><strong>单词:</strong> ${item.word} (${item.pinyin})</p>
                        <p><strong>你的答案:</strong> ${item.playerAnswer}</p>
                        <p><strong>正确答案:</strong> ${item.correctAnswer}</p>
                        <p><strong>时间:</strong> ${item.timestamp}</p>
                    `;
                    
                    wrongAnswersList.appendChild(wrongAnswerItem);
                });
            }
            
            document.getElementById('wrong-answers-modal').style.display = 'flex';
        }

        // 初始化语音合成
        function initializeSpeech() {
            if ('speechSynthesis' in window) {
                gameState.speechSupport = true;
                
                // 获取可用语音
                speechSynthesis.onvoiceschanged = function() {
                    gameState.voices = speechSynthesis.getVoices();
                    const voiceSelect = document.getElementById('voice-select');
                    
                    // 清空选项（除了默认选项）
                    while (voiceSelect.options.length > 1) {
                        voiceSelect.remove(1);
                    }
                    
                    // 添加中文语音选项
                    gameState.voices.forEach((voice, index) => {
                        if (voice.lang.startsWith('zh')) {
                            const option = document.createElement('option');
                            option.value = index;
                            option.textContent = `${voice.name} (${voice.lang})`;
                            voiceSelect.appendChild(option);
                        }
                    });
                };
                
                // 立即获取语音（如果已经加载）
                gameState.voices = speechSynthesis.getVoices();
                if (gameState.voices.length > 0) {
                    const voiceSelect = document.getElementById('voice-select');
                    
                    // 清空选项（除了默认选项）
                    while (voiceSelect.options.length > 1) {
                        voiceSelect.remove(1);
                    }
                    
                    // 添加中文语音选项
                    gameState.voices.forEach((voice, index) => {
                        if (voice.lang.startsWith('zh')) {
                            const option = document.createElement('option');
                            option.value = index;
                            option.textContent = `${voice.name} (${voice.lang})`;
                            voiceSelect.appendChild(option);
                        }
                    });
                }
            } else {
                alert('您的浏览器不支持语音合成功能，部分功能可能无法使用。');
            }
        }

        // 朗读文本
        function speakText(text) {
            if (!gameState.speechSupport) return;
            
            // 停止当前语音
            speechSynthesis.cancel();
            
            // 创建语音实例
            const utterance = new SpeechSynthesisUtterance(text);
            
            // 设置语音参数
            utterance.rate = gameState.rate;
            utterance.pitch = gameState.pitch;
            
            // 设置语音（如果已选择）
            if (gameState.currentVoice) {
                utterance.voice = gameState.currentVoice;
            } else {
                // 尝试使用中文语音
                const chineseVoices = gameState.voices.filter(voice => voice.lang.startsWith('zh'));
                if (chineseVoices.length > 0) {
                    utterance.voice = chineseVoices[0];
                }
            }
            
            // 朗读
            speechSynthesis.speak(utterance);
        }
    </script>
</body>
</html>