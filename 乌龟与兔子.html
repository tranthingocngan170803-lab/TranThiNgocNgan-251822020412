<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¹Œé¾Ÿå’Œå…”å­ - æ±‰è¯­æ‹¼éŸ³å­¦ä¹ æ¸¸æˆ</title>
    <style>
        /* å…¨å±€æ ·å¼ */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Microsoft YaHei', sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #f0f8ff 0%, #e6f7ff 100%);
            color: #333;
            line-height: 1.6;
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
            min-height: 100vh;
        }
        
        h1, h2, h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            text-shadow: 1px 1px 3px rgba(0,0,0,0.1);
        }
        
        button {
            background: linear-gradient(to bottom, #3498db, #2980b9);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s;
            box-shadow: 0 3px 5px rgba(0,0,0,0.2);
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 8px rgba(0,0,0,0.3);
        }
        
        button:active {
            transform: translateY(1px);
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }
        
        button:disabled {
            background: linear-gradient(to bottom, #95a5a6, #7f8c8d);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        /* ä¸»èœå•æ ·å¼ */
        #main-menu {
            text-align: center;
            padding: 30px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            background: linear-gradient(to bottom right, #ffffff, #f8f9fa);
        }
        
        .menu-options {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 20px;
            margin: 25px 0;
        }
        
        .menu-option {
            flex: 1;
            min-width: 220px;
            padding: 20px;
            background: linear-gradient(145deg, #ecf0f1, #dfe6e9);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            border: 2px solid transparent;
        }
        
        .menu-option:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 15px rgba(0,0,0,0.15);
            border-color: #3498db;
        }
        
        .menu-option.selected {
            background: linear-gradient(145deg, #3498db, #2980b9);
            color: white;
            border-color: #2980b9;
        }
        
        /* æ¸¸æˆåŒºåŸŸæ ·å¼ */
        #game-area {
            display: none;
            grid-template-columns: 2fr 1fr;
            gap: 25px;
            margin-top: 25px;
        }
        
        @media (max-width: 768px) {
            #game-area {
                grid-template-columns: 1fr;
            }
        }
        
        /* èµ›é“æ ·å¼ */
        #race-track {
            background: linear-gradient(to bottom, #2ecc71, #27ae60);
            border-radius: 15px;
            padding: 20px;
            position: relative;
            min-height: 350px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            border: 5px solid #27ae60;
        }
        
        .track-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 8px;
        }
        
        .track-cell {
            background-color: rgba(255, 255, 255, 0.85);
            border-radius: 8px;
            height: 70px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            position: relative;
            font-size: 18px;
            box-shadow: inset 0 0 5px rgba(0,0,0,0.1);
            border: 2px solid #27ae60;
        }
        
        .track-cell.finish {
            background: linear-gradient(45deg, #f1c40f, #e67e22);
            color: white;
            font-size: 24px;
        }
        
        .player {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            position: absolute;
            transition: left 0.5s, top 0.5s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            box-shadow: 0 3px 8px rgba(0,0,0,0.3);
            font-size: 20px;
            z-index: 10;
            border: 3px solid white;
        }
        
        .player-1 { background: linear-gradient(145deg, #e74c3c, #c0392b); } /* çº¢è‰²å…”å­ */
        .player-2 { background: linear-gradient(145deg, #3498db, #2980b9); } /* è“è‰²ä¹Œé¾Ÿ */
        .player-3 { background: linear-gradient(145deg, #f39c12, #d35400); } /* æ©™è‰²å…”å­ */
        .player-4 { background: linear-gradient(145deg, #9b59b6, #8e44ad); } /* ç´«è‰²ä¹Œé¾Ÿ */
        
        /* æ§åˆ¶é¢æ¿æ ·å¼ */
        #control-panel {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            background: linear-gradient(to bottom right, #ffffff, #f8f9fa);
            border: 2px solid #ecf0f1;
        }
        
        .player-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
            padding: 12px;
            border-radius: 8px;
            background: linear-gradient(to right, #f8f9fa, #ecf0f1);
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            border-left: 5px solid;
        }
        
        .player-info.active {
            background: linear-gradient(to right, #e3f2fd, #bbdefb);
            box-shadow: 0 3px 8px rgba(33, 150, 243, 0.3);
        }
        
        .progress-bar {
            height: 12px;
            background-color: #ecf0f1;
            border-radius: 6px;
            margin-top: 8px;
            overflow: hidden;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.2);
        }
        
        .progress {
            height: 100%;
            background: linear-gradient(to right, #2ecc71, #27ae60);
            width: 0%;
            transition: width 0.5s;
            border-radius: 6px;
        }
        
        #dice-container {
            text-align: center;
            margin: 25px 0;
            padding: 15px;
            background: linear-gradient(to bottom, #f8f9fa, #ecf0f1);
            border-radius: 12px;
            box-shadow: 0 3px 8px rgba(0,0,0,0.1);
        }
        
        #dice {
            width: 80px;
            height: 80px;
            background: linear-gradient(145deg, #ffffff, #f0f0f0);
            border: 3px solid #3498db;
            border-radius: 15px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            font-weight: bold;
            margin-bottom: 15px;
            box-shadow: 0 5px 10px rgba(0,0,0,0.2);
        }
        
        .dice-rolling {
            animation: roll 0.5s ease-in-out infinite;
        }
        
        @keyframes roll {
            0% { transform: rotate(0deg) scale(1); }
            50% { transform: rotate(180deg) scale(1.1); }
            100% { transform: rotate(360deg) scale(1); }
        }
        
        /* è¯­éŸ³è®¾ç½®æ ·å¼ */
        #voice-settings {
            margin: 20px 0;
            padding: 15px;
            background: linear-gradient(to bottom, #f8f9fa, #ecf0f1);
            border-radius: 12px;
            box-shadow: 0 3px 8px rgba(0,0,0,0.1);
        }
        
        .setting-group {
            margin-bottom: 15px;
        }
        
        .setting-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #2c3e50;
        }
        
        input[type="range"] {
            width: 100%;
            height: 8px;
            border-radius: 4px;
            background: #dfe6e9;
            outline: none;
        }
        
        select {
            width: 100%;
            padding: 8px;
            border-radius: 5px;
            border: 1px solid #bdc3c7;
            background: white;
        }
        
        /* é¢˜ç›®å¼¹çª—æ ·å¼ */
        #question-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(5px);
        }
        
        #question-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 600px;
            width: 90%;
            text-align: center;
            box-shadow: 0 15px 30px rgba(0,0,0,0.3);
            background: linear-gradient(to bottom right, #ffffff, #f8f9fa);
            border: 3px solid #3498db;
            position: relative;
        }
        
        .question-text {
            font-size: 22px;
            margin-bottom: 20px;
            color: #2c3e50;
            line-height: 1.5;
        }
        
        .options-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin: 25px 0;
        }
        
        @media (max-width: 480px) {
            .options-container {
                grid-template-columns: 1fr;
            }
        }
        
        .option {
            padding: 15px;
            background: linear-gradient(to bottom, #ecf0f1, #dfe6e9);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 18px;
            box-shadow: 0 3px 5px rgba(0,0,0,0.1);
            border: 2px solid transparent;
        }
        
        .option:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 10px rgba(0,0,0,0.2);
            border-color: #3498db;
        }
        
        .option.correct {
            background: linear-gradient(to bottom, #2ecc71, #27ae60);
            color: white;
        }
        
        .option.incorrect {
            background: linear-gradient(to bottom, #e74c3c, #c0392b);
            color: white;
        }
        
        /* é”™é¢˜æœ¬æ ·å¼ */
        #wrong-answers-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(5px);
        }
        
        #wrong-answers-content {
            background: white;
            padding: 25px;
            border-radius: 15px;
            max-width: 700px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 15px 30px rgba(0,0,0,0.3);
            background: linear-gradient(to bottom right, #ffffff, #f8f9fa);
            border: 3px solid #3498db;
        }
        
        .wrong-answer-item {
            padding: 15px;
            border-bottom: 1px solid #ecf0f1;
            margin-bottom: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        
        /* éš¾åº¦é€‰æ‹©æ ·å¼ */
        #difficulty-selection {
            display: none;
            text-align: center;
            margin-top: 20px;
        }
        
        .difficulty-option {
            display: inline-block;
            width: 150px;
            padding: 15px;
            margin: 0 10px;
            background: linear-gradient(145deg, #ecf0f1, #dfe6e9);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            border: 2px solid transparent;
        }
        
        .difficulty-option:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 15px rgba(0,0,0,0.15);
        }
        
        .difficulty-option.selected {
            color: white;
            border-color: transparent;
        }
        
        .difficulty-easy.selected {
            background: linear-gradient(145deg, #2ecc71, #27ae60);
        }
        
        .difficulty-medium.selected {
            background: linear-gradient(145deg, #f39c12, #d35400);
        }
        
        .difficulty-hard.selected {
            background: linear-gradient(145deg, #e74c3c, #c0392b);
        }
        
        /* èƒœåˆ©åŠ¨ç”»æ ·å¼ */
        .firework {
            position: absolute;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            pointer-events: none;
            z-index: 20;
        }
        
        @keyframes explode {
            0% { transform: translate(0, 0) scale(1); opacity: 1; }
            100% { transform: translate(var(--tx), var(--ty)) scale(0); opacity: 0; }
        }
        
        /* å“åº”å¼è°ƒæ•´ */
        @media (max-width: 768px) {
            .menu-options {
                flex-direction: column;
            }
            
            .options-container {
                grid-template-columns: 1fr;
            }
            
            .track-grid {
                grid-template-columns: repeat(5, 1fr);
            }
            
            .difficulty-option {
                display: block;
                width: 100%;
                margin: 10px 0;
            }
        }
        
        /* æ¸¸æˆæ ‡é¢˜æ ·å¼ */
        .game-title {
            text-align: center;
            margin-bottom: 10px;
            color: #2c3e50;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
        }
        
        .game-subtitle {
            text-align: center;
            margin-bottom: 30px;
            color: #7f8c8d;
            font-size: 1.2em;
        }
        
        /* é‡æ–°å¼€å§‹ç¡®è®¤å¯¹è¯æ¡† */
        #restart-confirm {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(5px);
        }
        
        #restart-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 400px;
            width: 90%;
            text-align: center;
            box-shadow: 0 15px 30px rgba(0,0,0,0.3);
            background: linear-gradient(to bottom right, #ffffff, #f8f9fa);
            border: 3px solid #3498db;
        }
        
        #restart-content h3 {
            color: #e74c3c;
            margin-bottom: 20px;
        }
        
        #restart-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
        }
        
        #confirm-restart {
            background: linear-gradient(to bottom, #e74c3c, #c0392b);
        }
        
        #cancel-restart {
            background: linear-gradient(to bottom, #95a5a6, #7f8c8d);
        }
        
        /* å¬åŠ›ç»ƒä¹ æŒ‰é’®æ ·å¼ */
        #listen-word {
            background: linear-gradient(to bottom, #9b59b6, #8e44ad);
            margin-left: 10px;
        }
        
        .button-group {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <!-- æ¸¸æˆæ ‡é¢˜ -->
    <div class="game-title">ğŸ¢ ä¹Œé¾Ÿå’Œå…”å­ ğŸ‡</div>
    <div class="game-subtitle">æ±‰è¯­æ‹¼éŸ³å­¦ä¹ æ¸¸æˆ - é€šè¿‡æœ‰è¶£çš„èµ›è·‘ç»ƒä¹ æ±‰è¯­æ‹¼éŸ³å’ŒHSK1è¯æ±‡</div>
    
    <!-- ä¸»èœå• -->
    <div id="main-menu">
        <h2>é€‰æ‹©æ¸¸æˆæ¨¡å¼</h2>
        
        <div class="menu-options">
            <div class="menu-option" id="mode-human-vs-computer">
                <h3>ğŸ¤– äººæœºå¯¹æˆ˜</h3>
                <p>ä¸ç”µè„‘ç©å®¶å¯¹æˆ˜</p>
            </div>
            <div class="menu-option" id="mode-human-vs-human">
                <h3>ğŸ‘¥ çœŸäººå¯¹æˆ˜</h3>
                <p>ä¸æœ‹å‹ä¸€èµ·ç©</p>
            </div>
        </div>
        
        <div id="player-selection" style="display: none;">
            <h3>é€‰æ‹©ç©å®¶æ•°é‡</h3>
            <div class="menu-options">
                <div class="menu-option player-count" data-count="2">2 åç©å®¶</div>
                <div class="menu-option player-count" data-count="3">3 åç©å®¶</div>
                <div class="menu-option player-count" data-count="4">4 åç©å®¶</div>
            </div>
        </div>
        
        <div id="computer-selection" style="display: none;">
            <h3>é€‰æ‹©ç”µè„‘ç©å®¶æ•°é‡</h3>
            <div class="menu-options">
                <div class="menu-option computer-count" data-count="1">1 ä¸ªç”µè„‘ç©å®¶</div>
                <div class="menu-option computer-count" data-count="2">2 ä¸ªç”µè„‘ç©å®¶</div>
                <div class="menu-option computer-count" data-count="3">3 ä¸ªç”µè„‘ç©å®¶</div>
            </div>
        </div>
        
        <!-- éš¾åº¦é€‰æ‹© -->
        <div id="difficulty-selection">
            <h3>é€‰æ‹©æ¸¸æˆéš¾åº¦</h3>
            <div style="margin: 20px 0;">
                <div class="difficulty-option difficulty-easy" data-difficulty="easy">
                    <h4>ğŸ“— ç®€å•</h4>
                    <p>HSK1 ç®€å•è¯æ±‡</p>
                </div>
                <div class="difficulty-option difficulty-medium" data-difficulty="medium">
                    <h4>ğŸ“˜ ä¸­ç­‰</h4>
                    <p>HSK1 ä¸­ç­‰è¯æ±‡</p>
                </div>
                <div class="difficulty-option difficulty-hard" data-difficulty="hard">
                    <h4>ğŸ“™ å›°éš¾</h4>
                    <p>HSK1 å›°éš¾è¯æ±‡</p>
                </div>
            </div>
        </div>
        
        <button id="start-game" style="display: none; margin-top: 30px; padding: 15px 30px; font-size: 18px;">å¼€å§‹æ¸¸æˆ</button>
    </div>
    
    <!-- æ¸¸æˆåŒºåŸŸ -->
    <div id="game-area">
        <!-- èµ›é“ -->
        <div id="race-track">
            <h2>ğŸ èµ›é“</h2>
            <div class="track-grid" id="track-grid">
                <!-- èµ›é“æ ¼å­å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
            </div>
        </div>
        
        <!-- æ§åˆ¶é¢æ¿ -->
        <div id="control-panel">
            <h2>ğŸ® æ¸¸æˆæ§åˆ¶</h2>
            
            <!-- ç©å®¶ä¿¡æ¯ -->
            <div id="players-info">
                <!-- ç©å®¶ä¿¡æ¯å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
            </div>
            
            <!-- æ·éª°å­åŒºåŸŸ -->
            <div id="dice-container">
                <div id="dice">?</div>
                <button id="roll-dice">æ·éª°å­</button>
            </div>
            
            <!-- è¯­éŸ³è®¾ç½® -->
            <div id="voice-settings">
                <h3>ğŸ”Š è¯­éŸ³è®¾ç½®</h3>
                <div class="setting-group">
                    <label for="voice-select">é€‰æ‹©è¯­éŸ³:</label>
                    <select id="voice-select">
                        <option value="">é»˜è®¤è¯­éŸ³</option>
                    </select>
                </div>
                <div class="setting-group">
                    <label for="rate-slider">è¯­é€Ÿ: <span id="rate-value">1</span></label>
                    <input type="range" id="rate-slider" min="0.5" max="2" step="0.1" value="1">
                </div>
                <div class="setting-group">
                    <label for="pitch-slider">éŸ³é«˜: <span id="pitch-value">1</span></label>
                    <input type="range" id="pitch-slider" min="0.5" max="2" step="0.1" value="1">
                </div>
                <button id="test-voice">æµ‹è¯•è¯­éŸ³</button>
            </div>
            
            <!-- å…¶ä»–æ§åˆ¶æŒ‰é’® -->
            <div style="margin-top: 25px;">
                <button id="view-wrong-answers">ğŸ“š æŸ¥çœ‹é”™é¢˜æœ¬</button>
                <button id="restart-game">ğŸ”„ é‡æ–°å¼€å§‹</button>
            </div>
        </div>
    </div>
    
    <!-- é¢˜ç›®å¼¹çª— -->
    <div id="question-modal">
        <div id="question-content">
            <h2 id="question-type">é¢˜ç›®ç±»å‹</h2>
            <div class="question-text" id="question-text">é¢˜ç›®å†…å®¹</div>
            <div class="options-container" id="options-container">
                <!-- é€‰é¡¹å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
            </div>
            <div class="button-group">
                <button id="speak-question">ğŸ”Š å†æ¬¡æœ—è¯»é¢˜ç›®</button>
                <button id="listen-word" style="display: none;">ğŸ”ˆ å†æ¬¡å¬å‘éŸ³</button>
            </div>
        </div>
    </div>
    
    <!-- é”™é¢˜æœ¬å¼¹çª— -->
    <div id="wrong-answers-modal">
        <div id="wrong-answers-content">
            <h2>ğŸ“š é”™é¢˜æœ¬</h2>
            <div id="wrong-answers-list">
                <!-- é”™é¢˜å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
            </div>
            <button id="close-wrong-answers" style="margin-top: 20px;">å…³é—­</button>
        </div>
    </div>
    
    <!-- é‡æ–°å¼€å§‹ç¡®è®¤å¯¹è¯æ¡† -->
    <div id="restart-confirm">
        <div id="restart-content">
            <h3>âš ï¸ é‡æ–°å¼€å§‹æ¸¸æˆ</h3>
            <p>ç¡®å®šè¦é‡æ–°å¼€å§‹æ¸¸æˆå—ï¼Ÿå½“å‰è¿›åº¦å°†ä¸¢å¤±ã€‚</p>
            <div id="restart-buttons">
                <button id="confirm-restart">ç¡®å®š</button>
                <button id="cancel-restart">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <script>
        // æ¸¸æˆçŠ¶æ€å’Œé…ç½®
        const gameState = {
            currentPlayer: 0,
            players: [],
            totalCells: 36, // åŒ…æ‹¬èµ·ç‚¹
            gameMode: null, // 'human-vs-computer' æˆ– 'human-vs-human'
            humanPlayers: 1,
            computerPlayers: 0,
            difficulty: 'easy', // 'easy', 'medium', 'hard'
            isGameActive: false,
            speechSupport: false,
            voices: [],
            currentVoice: null,
            rate: 1,
            pitch: 1,
            questions: [],
            askedQuestions: [], // è·Ÿè¸ªå·²é—®è¿‡çš„é—®é¢˜
            wrongAnswers: JSON.parse(localStorage.getItem('wrongAnswers')) || [],
            currentQuestion: null // å­˜å‚¨å½“å‰é—®é¢˜
        };

        // å£°æ¯å®šä¹‰
        const initials = ['b', 'p', 'm', 'f', 'd', 't', 'n', 'l', 'g', 'k', 'h', 'j', 'q', 'x', 'zh', 'ch', 'sh', 'r', 'z', 'c', 's'];

        // HSK1è¯æ±‡åº“ - åˆ†ä¸ºä¸‰ä¸ªéš¾åº¦çº§åˆ«
        const hsk1Vocabulary = {
            // ç®€å•ç»„
            easy: [
                { word: 'ä½ ', pinyin: 'nÇ', meaning: 'báº¡n', type: 'pronoun' },
                { word: 'ä»–', pinyin: 'tÄ', meaning: 'anh áº¥y', type: 'pronoun' },
                { word: 'å¥¹', pinyin: 'tÄ', meaning: 'cÃ´ áº¥y', type: 'pronoun' },
                { word: 'æ˜¯', pinyin: 'shÃ¬', meaning: 'lÃ ', type: 'verb' },
                { word: 'ä¸', pinyin: 'bÃ¹', meaning: 'khÃ´ng', type: 'adverb' },
                { word: 'å¥½', pinyin: 'hÇo', meaning: 'tá»‘t, khá»e', type: 'adjective' },
                { word: 'å†è§', pinyin: 'zÃ ijiÃ n', meaning: 'táº¡m biá»‡t', type: 'phrase' },
                { word: 'è°¢è°¢', pinyin: 'xiÃ¨xie', meaning: 'cáº£m Æ¡n', type: 'phrase' },
                { word: 'å¯¹ä¸èµ·', pinyin: 'duÃ¬buqÇ', meaning: 'xin lá»—i', type: 'phrase' },
                { word: 'æ²¡å…³ç³»', pinyin: 'mÃ©i guÄnxi', meaning: 'khÃ´ng sao', type: 'phrase' },
                { word: 'è¯·', pinyin: 'qÇng', meaning: 'má»i, xin', type: 'verb' },
                { word: 'äº‹', pinyin: 'shÃ¬', meaning: 'viá»‡c, sá»± viá»‡c', type: 'noun' },
                { word: 'è¿™', pinyin: 'zhÃ¨', meaning: 'Ä‘Ã¢y, nÃ y', type: 'pronoun' },
                { word: 'é‚£', pinyin: 'nÃ ', meaning: 'kia, Ä‘Ã³', type: 'pronoun' },
                { word: 'å“ª', pinyin: 'nÇ', meaning: 'nÃ o, cÃ¡i nÃ o', type: 'pronoun' },
                { word: 'è°', pinyin: 'shÃ©i', meaning: 'ai', type: 'pronoun' },
                { word: 'ä»€ä¹ˆ', pinyin: 'shÃ©nme', meaning: 'cÃ¡i gÃ¬', type: 'pronoun' },
                { word: 'æ€ä¹ˆ', pinyin: 'zÄ›nme', meaning: 'tháº¿ nÃ o', type: 'pronoun' },
                { word: 'å¤šå°‘', pinyin: 'duÅshao', meaning: 'bao nhiÃªu', type: 'pronoun' },
                { word: 'ä¸‰', pinyin: 'sÄn', meaning: 'ba', type: 'numeral' },
                { word: 'å››', pinyin: 'sÃ¬', meaning: 'bá»‘n', type: 'numeral' },
                { word: 'å…­', pinyin: 'liÃ¹', meaning: 'sÃ¡u', type: 'numeral' },
                { word: 'ä¸ƒ', pinyin: 'qÄ«', meaning: 'báº£y', type: 'numeral' },
                { word: 'å…«', pinyin: 'bÄ', meaning: 'tÃ¡m', type: 'numeral' },
                { word: 'ä¹', pinyin: 'jiÇ”', meaning: 'chÃ­n', type: 'numeral' },
                { word: 'å', pinyin: 'shÃ­', meaning: 'mÆ°á»i', type: 'numeral' }
            ],
            // ä¸­ç­‰ç»„
            medium: [
                { word: 'ä¸­å›½', pinyin: 'zhÅngguÃ³', meaning: 'Trung Quá»‘c', type: 'noun' },
                { word: 'åŒ—äº¬', pinyin: 'bÄ›ijÄ«ng', meaning: 'Báº¯c Kinh', type: 'noun' },
                { word: 'åå­—', pinyin: 'mÃ­ngzi', meaning: 'tÃªn', type: 'noun' },
                { word: 'è€å¸ˆ', pinyin: 'lÇoshÄ«', meaning: 'tháº§y/cÃ´ giÃ¡o', type: 'noun' },
                { word: 'å­¦ç”Ÿ', pinyin: 'xuÃ©sheng', meaning: 'há»c sinh', type: 'noun' },
                { word: 'åŒå­¦', pinyin: 'tÃ³ngxuÃ©', meaning: 'báº¡n há»c', type: 'noun' },
                { word: 'æœ‹å‹', pinyin: 'pÃ©ngyou', meaning: 'báº¡n bÃ¨', type: 'noun' },
                { word: 'çˆ¸çˆ¸', pinyin: 'bÃ ba', meaning: 'bá»‘', type: 'noun' },
                { word: 'å¦ˆå¦ˆ', pinyin: 'mÄma', meaning: 'máº¹', type: 'noun' },
                { word: 'å¥³å„¿', pinyin: 'nÇš\'Ã©r', meaning: 'con gÃ¡i', type: 'noun' },
                { word: 'å…ˆç”Ÿ', pinyin: 'xiÄnsheng', meaning: 'Ã´ng, ngÃ i', type: 'noun' },
                { word: 'å°å§', pinyin: 'xiÇojiÄ›', meaning: 'cÃ´ (Miss)', type: 'noun' },
                { word: 'æ°´', pinyin: 'shuÇ', meaning: 'nÆ°á»›c', type: 'noun' },
                { word: 'èŒ¶', pinyin: 'chÃ¡', meaning: 'trÃ ', type: 'noun' },
                { word: 'ç±³é¥­', pinyin: 'mÇfÃ n', meaning: 'cÆ¡m', type: 'noun' },
                { word: 'èœ', pinyin: 'cÃ i', meaning: 'mÃ³n Äƒn', type: 'noun' },
                { word: 'è‹¹æœ', pinyin: 'pÃ­ngguÇ’', meaning: 'tÃ¡o', type: 'noun' },
                { word: 'å•†åº—', pinyin: 'shÄngdiÃ n', meaning: 'cá»­a hÃ ng', type: 'noun' },
                { word: 'å­¦æ ¡', pinyin: 'xuÃ©xiÃ o', meaning: 'trÆ°á»ng há»c', type: 'noun' },
                { word: 'ç«è½¦ç«™', pinyin: 'huÇ’chÄ“zhÃ n', meaning: 'ga tÃ u', type: 'noun' },
                { word: 'æ±‰è¯­', pinyin: 'hÃ nyÇ”', meaning: 'tiáº¿ng HÃ¡n', type: 'noun' },
                { word: 'å­—', pinyin: 'zÃ¬', meaning: 'chá»¯', type: 'noun' },
                { word: 'ä¹¦', pinyin: 'shÅ«', meaning: 'sÃ¡ch', type: 'noun' },
                { word: 'æ¯å­', pinyin: 'bÄ“izi', meaning: 'cá»‘c', type: 'noun' },
                { word: 'æ¡Œå­', pinyin: 'zhuÅzi', meaning: 'bÃ n', type: 'noun' },
                { word: 'é’±', pinyin: 'qiÃ¡n', meaning: 'tiá»n', type: 'noun' },
                { word: 'ä¸œè¥¿', pinyin: 'dÅngxi', meaning: 'Ä‘á»“ váº­t', type: 'noun' },
                { word: 'æ—¥', pinyin: 'rÃ¬', meaning: 'ngÃ y, máº·t trá»i', type: 'noun' },
                { word: 'å¹´', pinyin: 'niÃ¡n', meaning: 'nÄƒm', type: 'noun' }
            ],
            // å›°éš¾ç»„
            hard: [
                { word: 'ä¸Šåˆ', pinyin: 'shÃ ngwÇ”', meaning: 'buá»•i sÃ¡ng', type: 'noun' },
                { word: 'ä¸­åˆ', pinyin: 'zhÅngwÇ”', meaning: 'buá»•i trÆ°a', type: 'noun' },
                { word: 'ä¸‹åˆ', pinyin: 'xiÃ wÇ”', meaning: 'buá»•i chiá»u', type: 'noun' },
                { word: 'ä»Šå¤©', pinyin: 'jÄ«ntiÄn', meaning: 'hÃ´m nay', type: 'noun' },
                { word: 'æ˜å¤©', pinyin: 'mÃ­ngtiÄn', meaning: 'ngÃ y mai', type: 'noun' },
                { word: 'æ˜¨å¤©', pinyin: 'zuÃ³tiÄn', meaning: 'hÃ´m qua', type: 'noun' },
                { word: 'ç°åœ¨', pinyin: 'xiÃ nzÃ i', meaning: 'bÃ¢y giá»', type: 'noun' },
                { word: 'æ—¶å€™', pinyin: 'shÃ­hou', meaning: 'lÃºc, khi', type: 'noun' },
                { word: 'ç‚¹', pinyin: 'diÇn', meaning: 'giá»', type: 'noun' },
                { word: 'åˆ†é’Ÿ', pinyin: 'fÄ“nzhÅng', meaning: 'phÃºt', type: 'noun' },
                { word: 'å…ˆç”Ÿ', pinyin: 'xiÄnsheng', meaning: 'Ã´ng (cÃ¡ch gá»i trang trá»ng)', type: 'noun' },
                { word: 'å·¥ä½œ', pinyin: 'gÅngzuÃ²', meaning: 'cÃ´ng viá»‡c', type: 'noun/verb' },
                { word: 'å­¦ä¹ ', pinyin: 'xuÃ©xÃ­', meaning: 'há»c táº­p', type: 'verb' },
                { word: 'ä½', pinyin: 'zhÃ¹', meaning: 'sá»‘ng, á»Ÿ', type: 'verb' },
                { word: 'å', pinyin: 'zuÃ²', meaning: 'ngá»“i', type: 'verb' },
                { word: 'è¯»', pinyin: 'dÃº', meaning: 'Ä‘á»c', type: 'verb' },
                { word: 'å†™', pinyin: 'xiÄ›', meaning: 'viáº¿t', type: 'verb' },
                { word: 'çœ‹', pinyin: 'kÃ n', meaning: 'nhÃ¬n, xem', type: 'verb' },
                { word: 'å¬', pinyin: 'tÄ«ng', meaning: 'nghe', type: 'verb' },
                { word: 'è¯´è¯', pinyin: 'shuÅhuÃ ', meaning: 'nÃ³i chuyá»‡n', type: 'verb' },
                { word: 'æ‰“ç”µè¯', pinyin: 'dÇ diÃ nhuÃ ', meaning: 'gá»i Ä‘iá»‡n thoáº¡i', type: 'verb' },
                { word: 'çœ‹è§', pinyin: 'kÃ njiÃ n', meaning: 'nhÃ¬n tháº¥y', type: 'verb' },
                { word: 'å–œæ¬¢', pinyin: 'xÇhuan', meaning: 'thÃ­ch', type: 'verb' },
                { word: 'æƒ³', pinyin: 'xiÇng', meaning: 'nghÄ©, muá»‘n', type: 'verb' },
                { word: 'åš', pinyin: 'zuÃ²', meaning: 'lÃ m', type: 'verb' },
                { word: 'ä¹°', pinyin: 'mÇi', meaning: 'mua', type: 'verb' },
                { word: 'å¼€', pinyin: 'kÄi', meaning: 'má»Ÿ, lÃ¡i (xe)', type: 'verb' },
                { word: 'å›', pinyin: 'huÃ­', meaning: 'trá»Ÿ vá»', type: 'verb' },
                { word: 'å»', pinyin: 'qÃ¹', meaning: 'Ä‘i', type: 'verb' },
                { word: 'æ¥', pinyin: 'lÃ¡i', meaning: 'Ä‘áº¿n', type: 'verb' },
                { word: 'ç»™', pinyin: 'gÄ›i', meaning: 'cho', type: 'verb' },
                { word: 'åœ¨', pinyin: 'zÃ i', meaning: 'á»Ÿ, táº¡i', type: 'verb/preposition' }
            ]
        };

        // åˆå§‹åŒ–æ¸¸æˆ
        document.addEventListener('DOMContentLoaded', function() {
            initializeGame();
            setupEventListeners();
            initializeSpeech();
        });

        // åˆå§‹åŒ–æ¸¸æˆ
        function initializeGame() {
            createTrack();
            updatePlayersInfo();
        }

        // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
        function setupEventListeners() {
            // æ¸¸æˆæ¨¡å¼é€‰æ‹©
            document.getElementById('mode-human-vs-computer').addEventListener('click', function() {
                selectGameMode('human-vs-computer');
            });
            
            document.getElementById('mode-human-vs-human').addEventListener('click', function() {
                selectGameMode('human-vs-human');
            });
            
            // ç©å®¶æ•°é‡é€‰æ‹©
            document.querySelectorAll('.player-count').forEach(option => {
                option.addEventListener('click', function() {
                    document.querySelectorAll('.player-count').forEach(o => o.classList.remove('selected'));
                    this.classList.add('selected');
                    gameState.humanPlayers = parseInt(this.getAttribute('data-count'));
                    showDifficultySelection();
                });
            });
            
            // ç”µè„‘ç©å®¶æ•°é‡é€‰æ‹©
            document.querySelectorAll('.computer-count').forEach(option => {
                option.addEventListener('click', function() {
                    document.querySelectorAll('.computer-count').forEach(o => o.classList.remove('selected'));
                    this.classList.add('selected');
                    gameState.computerPlayers = parseInt(this.getAttribute('data-count'));
                    showDifficultySelection();
                });
            });
            
            // éš¾åº¦é€‰æ‹©
            document.querySelectorAll('.difficulty-option').forEach(option => {
                option.addEventListener('click', function() {
                    document.querySelectorAll('.difficulty-option').forEach(o => o.classList.remove('selected'));
                    this.classList.add('selected');
                    gameState.difficulty = this.getAttribute('data-difficulty');
                    document.getElementById('start-game').style.display = 'inline-block';
                });
            });
            
            // å¼€å§‹æ¸¸æˆæŒ‰é’®
            document.getElementById('start-game').addEventListener('click', startGame);
            
            // æ·éª°å­æŒ‰é’®
            document.getElementById('roll-dice').addEventListener('click', rollDice);
            
            // è¯­éŸ³è®¾ç½®
            document.getElementById('rate-slider').addEventListener('input', function() {
                document.getElementById('rate-value').textContent = this.value;
                gameState.rate = parseFloat(this.value);
            });
            
            document.getElementById('pitch-slider').addEventListener('input', function() {
                document.getElementById('pitch-value').textContent = this.value;
                gameState.pitch = parseFloat(this.value);
            });
            
            document.getElementById('voice-select').addEventListener('change', function() {
                const voiceIndex = this.selectedIndex - 1; // å‡å»é»˜è®¤é€‰é¡¹
                if (voiceIndex >= 0 && voiceIndex < gameState.voices.length) {
                    gameState.currentVoice = gameState.voices[voiceIndex];
                } else {
                    gameState.currentVoice = null;
                }
            });
            
            document.getElementById('test-voice').addEventListener('click', function() {
                speakText('è¿™æ˜¯ä¸€ä¸ªè¯­éŸ³æµ‹è¯•ã€‚ä¹Œé¾Ÿå’Œå…”å­æ±‰è¯­æ‹¼éŸ³å­¦ä¹ æ¸¸æˆã€‚');
            });
            
            // é”™é¢˜æœ¬æŒ‰é’®
            document.getElementById('view-wrong-answers').addEventListener('click', showWrongAnswers);
            document.getElementById('close-wrong-answers').addEventListener('click', function() {
                document.getElementById('wrong-answers-modal').style.display = 'none';
            });
            
            // é‡æ–°å¼€å§‹æŒ‰é’®
            document.getElementById('restart-game').addEventListener('click', function() {
                document.getElementById('restart-confirm').style.display = 'flex';
            });
            
            document.getElementById('confirm-restart').addEventListener('click', function() {
                document.getElementById('restart-confirm').style.display = 'none';
                restartGame();
            });
            
            document.getElementById('cancel-restart').addEventListener('click', function() {
                document.getElementById('restart-confirm').style.display = 'none';
            });
            
            // è¯­éŸ³æŒ‰é’®
            document.getElementById('speak-question').addEventListener('click', function() {
                if (gameState.currentQuestion) {
                    speakQuestion(gameState.currentQuestion);
                }
            });
            
            document.getElementById('listen-word').addEventListener('click', function() {
                if (gameState.currentQuestion && gameState.currentQuestion.type === 'listening') {
                    speakText(gameState.currentQuestion.word);
                }
            });
        }

        // é€‰æ‹©æ¸¸æˆæ¨¡å¼
        function selectGameMode(mode) {
            gameState.gameMode = mode;
            
            // æ›´æ–°UI
            document.querySelectorAll('.menu-option').forEach(option => {
                option.classList.remove('selected');
            });
            
            if (mode === 'human-vs-computer') {
                document.getElementById('mode-human-vs-computer').classList.add('selected');
                document.getElementById('player-selection').style.display = 'none';
                document.getElementById('computer-selection').style.display = 'block';
                
                // é»˜è®¤é€‰æ‹©1ä¸ªç”µè„‘ç©å®¶
                document.querySelector('.computer-count[data-count="1"]').click();
            } else {
                document.getElementById('mode-human-vs-human').classList.add('selected');
                document.getElementById('player-selection').style.display = 'block';
                document.getElementById('computer-selection').style.display = 'none';
                
                // é»˜è®¤é€‰æ‹©2åç©å®¶
                document.querySelector('.player-count[data-count="2"]').click();
            }
        }

        // æ˜¾ç¤ºéš¾åº¦é€‰æ‹©
        function showDifficultySelection() {
            document.getElementById('difficulty-selection').style.display = 'block';
            
            // é»˜è®¤é€‰æ‹©ç®€å•éš¾åº¦
            document.querySelector('.difficulty-option[data-difficulty="easy"]').click();
        }

        // å¼€å§‹æ¸¸æˆ
        function startGame() {
            // éšè—ä¸»èœå•ï¼Œæ˜¾ç¤ºæ¸¸æˆåŒºåŸŸ
            document.getElementById('main-menu').style.display = 'none';
            document.getElementById('game-area').style.display = 'grid';
            
            // åˆå§‹åŒ–ç©å®¶
            initializePlayers();
            
            // åˆ›å»ºèµ›é“
            createTrack();
            
            // æ›´æ–°ç©å®¶ä¿¡æ¯
            updatePlayersInfo();
            
            // è®¾ç½®æ¸¸æˆçŠ¶æ€
            gameState.isGameActive = true;
            gameState.currentPlayer = 0;
            
            // åˆå§‹åŒ–é—®é¢˜åº“
            initializeQuestions();
            
            // å¦‚æœæ˜¯ç”µè„‘ç©å®¶ä¸”å½“å‰è½®åˆ°ç”µè„‘ï¼Œè‡ªåŠ¨æ·éª°å­
            if (gameState.players[gameState.currentPlayer].isComputer) {
                setTimeout(() => {
                    rollDice();
                }, 1000);
            }
        }

        // åˆå§‹åŒ–ç©å®¶
        function initializePlayers() {
            gameState.players = [];
            
            // æ ¹æ®æ¸¸æˆæ¨¡å¼æ·»åŠ ç©å®¶
            if (gameState.gameMode === 'human-vs-computer') {
                // æ·»åŠ äººç±»ç©å®¶
                gameState.players.push({
                    id: 1,
                    name: 'ç©å®¶ 1',
                    position: 0,
                    isComputer: false,
                    color: 'player-1'
                });
                
                // æ·»åŠ ç”µè„‘ç©å®¶
                for (let i = 1; i <= gameState.computerPlayers; i++) {
                    gameState.players.push({
                        id: i + 1,
                        name: `ç”µè„‘ ${i}`,
                        position: 0,
                        isComputer: true,
                        color: `player-${i + 1}`
                    });
                }
            } else {
                // æ·»åŠ äººç±»ç©å®¶
                for (let i = 1; i <= gameState.humanPlayers; i++) {
                    gameState.players.push({
                        id: i,
                        name: `ç©å®¶ ${i}`,
                        position: 0,
                        isComputer: false,
                        color: `player-${i}`
                    });
                }
            }
        }

        // åˆ›å»ºèµ›é“
        function createTrack() {
            const trackGrid = document.getElementById('track-grid');
            trackGrid.innerHTML = '';
            
            // åˆ›å»ºèµ·ç‚¹æ ¼å­
            const startCell = document.createElement('div');
            startCell.className = 'track-cell';
            startCell.id = `cell-0`;
            startCell.textContent = 'èµ·ç‚¹';
            trackGrid.appendChild(startCell);
            
            // åˆ›å»ºèµ›é“æ ¼å­ï¼ˆä»1å¼€å§‹ï¼‰
            for (let i = 1; i < gameState.totalCells; i++) {
                const cell = document.createElement('div');
                cell.className = 'track-cell';
                cell.id = `cell-${i}`;
                
                // æœ€åä¸€ä¸ªæ ¼å­æ˜¯ç»ˆç‚¹
                if (i === gameState.totalCells - 1) {
                    cell.classList.add('finish');
                    cell.textContent = 'ğŸ';
                } else {
                    cell.textContent = i;
                }
                
                trackGrid.appendChild(cell);
            }
            
            // æ”¾ç½®ç©å®¶åˆ°èµ·ç‚¹
            placePlayersOnTrack();
        }

        // æ”¾ç½®ç©å®¶åˆ°èµ›é“ä¸Š
        function placePlayersOnTrack() {
            // æ¸…é™¤ä¹‹å‰çš„ç©å®¶
            document.querySelectorAll('.player').forEach(player => player.remove());
            
            // æ”¾ç½®æ¯ä¸ªç©å®¶
            gameState.players.forEach((player, index) => {
                const playerElement = document.createElement('div');
                playerElement.className = `player ${player.color}`;
                playerElement.id = `player-${player.id}`;
                playerElement.textContent = player.id;
                
                // å°†ç©å®¶æ”¾ç½®åœ¨èµ·ç‚¹
                const startCell = document.getElementById('cell-0');
                const rect = startCell.getBoundingClientRect();
                const trackRect = document.getElementById('race-track').getBoundingClientRect();
                
                // è®¡ç®—ç©å®¶åœ¨æ ¼å­ä¸­çš„ä½ç½®ï¼ˆåˆ†æ•£æ”¾ç½®ï¼‰
                const offsetX = (index % 3) * 15 - 15;
                const offsetY = Math.floor(index / 3) * 15 - 15;
                
                playerElement.style.left = `${rect.left - trackRect.left + offsetX}px`;
                playerElement.style.top = `${rect.top - trackRect.top + offsetY}px`;
                
                document.getElementById('race-track').appendChild(playerElement);
            });
        }

        // æ›´æ–°ç©å®¶ä¿¡æ¯
        function updatePlayersInfo() {
            const playersInfo = document.getElementById('players-info');
            playersInfo.innerHTML = '';
            
            gameState.players.forEach((player, index) => {
                const playerInfo = document.createElement('div');
                playerInfo.className = `player-info ${index === gameState.currentPlayer ? 'active' : ''}`;
                playerInfo.style.borderLeftColor = getPlayerColor(player.color);
                
                playerInfo.innerHTML = `
                    <div>
                        <strong>${player.name}</strong>
                        <div class="progress-bar">
                            <div class="progress" style="width: ${(player.position / (gameState.totalCells - 1)) * 100}%"></div>
                        </div>
                    </div>
                    <div>ä½ç½®: ${player.position === 0 ? 'èµ·ç‚¹' : player.position}</div>
                `;
                
                playersInfo.appendChild(playerInfo);
            });
        }

        // è·å–ç©å®¶é¢œè‰²
        function getPlayerColor(colorClass) {
            const colorMap = {
                'player-1': '#e74c3c',
                'player-2': '#3498db',
                'player-3': '#f39c12',
                'player-4': '#9b59b6'
            };
            
            return colorMap[colorClass] || '#3498db';
        }

        // æ·éª°å­
        function rollDice() {
            if (!gameState.isGameActive) return;
            
            const dice = document.getElementById('dice');
            const rollButton = document.getElementById('roll-dice');
            
            // ç¦ç”¨æ·éª°å­æŒ‰é’®
            rollButton.disabled = true;
            
            // éª°å­æ»šåŠ¨åŠ¨ç”»
            dice.classList.add('dice-rolling');
            dice.textContent = '?';
            
            // æ¨¡æ‹Ÿéª°å­æ»šåŠ¨
            let rollCount = 0;
            const maxRolls = 10;
            const rollInterval = setInterval(() => {
                dice.textContent = Math.floor(Math.random() * 6) + 1;
                rollCount++;
                
                if (rollCount >= maxRolls) {
                    clearInterval(rollInterval);
                    
                    // ç¡®å®šæœ€ç»ˆç‚¹æ•°
                    const rollValue = Math.floor(Math.random() * 6) + 1;
                    dice.textContent = rollValue;
                    dice.classList.remove('dice-rolling');
                    
                    // ç§»åŠ¨ç©å®¶
                    setTimeout(() => {
                        movePlayer(rollValue);
                    }, 500);
                }
            }, 100);
        }

        // ç§»åŠ¨ç©å®¶
        function movePlayer(steps) {
            const currentPlayer = gameState.players[gameState.currentPlayer];
            const newPosition = Math.min(currentPlayer.position + steps, gameState.totalCells - 1);
            
            // æ›´æ–°ç©å®¶ä½ç½®
            currentPlayer.position = newPosition;
            
            // ç§»åŠ¨ç©å®¶å›¾æ ‡
            const playerElement = document.getElementById(`player-${currentPlayer.id}`);
            const targetCell = document.getElementById(`cell-${newPosition}`);
            const trackRect = document.getElementById('race-track').getBoundingClientRect();
            const cellRect = targetCell.getBoundingClientRect();
            
            playerElement.style.left = `${cellRect.left - trackRect.left}px`;
            playerElement.style.top = `${cellRect.top - trackRect.top}px`;
            
            // æ›´æ–°ç©å®¶ä¿¡æ¯
            updatePlayersInfo();
            
            // æ£€æŸ¥æ˜¯å¦åˆ°è¾¾ç»ˆç‚¹
            if (newPosition === gameState.totalCells - 1) {
                endGame(currentPlayer);
                return;
            }
            
            // æ˜¾ç¤ºé—®é¢˜ï¼ˆåªæœ‰å½“ç©å®¶ä¸åœ¨èµ·ç‚¹æ—¶æ‰æ˜¾ç¤ºé—®é¢˜ï¼‰
            if (newPosition > 0) {
                setTimeout(() => {
                    showQuestion();
                }, 1000);
            } else {
                // å¦‚æœå›åˆ°èµ·ç‚¹ï¼Œç›´æ¥è¿›å…¥ä¸‹ä¸€å›åˆ
                setTimeout(() => {
                    nextTurn();
                }, 1000);
            }
        }

        // åˆå§‹åŒ–é—®é¢˜åº“
        function initializeQuestions() {
            // æ¸…ç©ºå·²é—®é—®é¢˜åˆ—è¡¨
            gameState.askedQuestions = [];
            
            // æ ¹æ®éš¾åº¦é€‰æ‹©è¯æ±‡
            const vocabulary = hsk1Vocabulary[gameState.difficulty];
            
            // ç”Ÿæˆé—®é¢˜
            gameState.questions = [];
            
            vocabulary.forEach(word => {
                // å£°æ¯é—®é¢˜
                gameState.questions.push({
                    type: 'initial',
                    word: word.word,
                    pinyin: word.pinyin,
                    meaning: word.meaning,
                    question: word.word.split('').length > 1 ? 
                        `"${word.word}"çš„ç¬¬ä¸€ä¸ªå­—å£°æ¯æ˜¯ä»€ä¹ˆï¼Ÿ` : 
                        `"${word.word}"çš„å£°æ¯æ˜¯ä»€ä¹ˆï¼Ÿ`,
                    options: generateInitialOptions(word.pinyin),
                    correctAnswer: getInitial(word.pinyin)
                });
                
                // æ‹¼éŸ³é—®é¢˜
                gameState.questions.push({
                    type: 'pinyin',
                    word: word.word,
                    pinyin: word.pinyin,
                    meaning: word.meaning,
                    question: `"${word.word}"çš„æ­£ç¡®æ‹¼éŸ³æ˜¯ä»€ä¹ˆï¼Ÿ`,
                    options: generatePinyinOptions(word.pinyin),
                    correctAnswer: word.pinyin
                });
                
                // è¯ä¹‰é—®é¢˜
                gameState.questions.push({
                    type: 'meaning',
                    word: word.word,
                    pinyin: word.pinyin,
                    meaning: word.meaning,
                    question: `"${word.word}"çš„è¶Šå—è¯­æ˜¯ä»€ä¹ˆæ„æ€ï¼Ÿ`,
                    options: generateMeaningOptions(word.meaning),
                    correctAnswer: word.meaning
                });
                
                // å¬åŠ›é—®é¢˜
                gameState.questions.push({
                    type: 'listening',
                    word: word.word,
                    pinyin: word.pinyin,
                    meaning: word.meaning,
                    question: `è¯·å¬å‘éŸ³ï¼Œé€‰æ‹©æ­£ç¡®çš„ç­”æ¡ˆ`,
                    options: generateListeningOptions(word.word, vocabulary),
                    correctAnswer: word.word
                });
            });
        }

        // è·å–å£°æ¯
        function getInitial(pinyin) {
            // å¤„ç†å¤šéŸ³èŠ‚è¯çš„ç¬¬ä¸€ä¸ªéŸ³èŠ‚
            const firstSyllable = pinyin.replace(/[ÄÃ¡ÇÃ Ä“Ã©Ä›Ã¨Ä«Ã­ÇÃ¬ÅÃ³Ç’Ã²Å«ÃºÇ”Ã¹Ç–Ç˜ÇšÇœ]/g, '').split('')[0];
            
            // æ£€æŸ¥æ˜¯å¦æ˜¯å¤åˆå£°æ¯ (zh, ch, sh)
            if (pinyin.startsWith('zh') || pinyin.startsWith('ch') || pinyin.startsWith('sh')) {
                return pinyin.substring(0, 2);
            }
            
            return firstSyllable;
        }

        // ç”Ÿæˆå£°æ¯é€‰é¡¹
        function generateInitialOptions(correctPinyin) {
            const correctInitial = getInitial(correctPinyin);
            const options = [correctInitial];
            
            // æ·»åŠ æ··æ·†é€‰é¡¹
            while (options.length < 4) {
                const randomInitial = initials[Math.floor(Math.random() * initials.length)];
                if (!options.includes(randomInitial) && randomInitial !== correctInitial) {
                    // ç¡®ä¿æ··æ·†é€‰é¡¹ä¸æ­£ç¡®ç­”æ¡ˆç›¸ä¼¼ï¼ˆä¾‹å¦‚zå’Œzhï¼‰
                    if ((correctInitial === 'z' && randomInitial === 'zh') || 
                        (correctInitial === 'zh' && randomInitial === 'z') ||
                        (correctInitial === 'c' && randomInitial === 'ch') ||
                        (correctInitial === 'ch' && randomInitial === 'c') ||
                        (correctInitial === 's' && randomInitial === 'sh') ||
                        (correctInitial === 'sh' && randomInitial === 's') ||
                        Math.random() < 0.7) { // 70%çš„æ¦‚ç‡æ·»åŠ ç›¸ä¼¼é€‰é¡¹
                        options.push(randomInitial);
                    }
                }
            }
            
            // éšæœºæ’åºé€‰é¡¹
            return shuffleArray(options);
        }

        // ç”Ÿæˆæ‹¼éŸ³é€‰é¡¹
        function generatePinyinOptions(correctPinyin) {
            const options = [correctPinyin];
            
            // æ·»åŠ æ··æ·†é€‰é¡¹
            while (options.length < 4) {
                // ä»åŒä¸€éš¾åº¦çº§åˆ«çš„è¯æ±‡ä¸­éšæœºé€‰æ‹©æ‹¼éŸ³
                const vocabulary = hsk1Vocabulary[gameState.difficulty];
                const randomWord = vocabulary[Math.floor(Math.random() * vocabulary.length)];
                const randomPinyin = randomWord.pinyin;
                
                if (!options.includes(randomPinyin) && randomPinyin !== correctPinyin) {
                    options.push(randomPinyin);
                }
            }
            
            // éšæœºæ’åºé€‰é¡¹
            return shuffleArray(options);
        }

        // ç”Ÿæˆè¯ä¹‰é€‰é¡¹
        function generateMeaningOptions(correctMeaning) {
            const options = [correctMeaning];
            
            // æ·»åŠ æ··æ·†é€‰é¡¹
            while (options.length < 4) {
                // ä»åŒä¸€éš¾åº¦çº§åˆ«çš„è¯æ±‡ä¸­éšæœºé€‰æ‹©è¯ä¹‰
                const vocabulary = hsk1Vocabulary[gameState.difficulty];
                const randomWord = vocabulary[Math.floor(Math.random() * vocabulary.length)];
                const randomMeaning = randomWord.meaning;
                
                if (!options.includes(randomMeaning) && randomMeaning !== correctMeaning) {
                    options.push(randomMeaning);
                }
            }
            
            // éšæœºæ’åºé€‰é¡¹
            return shuffleArray(options);
        }

        // ç”Ÿæˆå¬åŠ›é€‰é¡¹
        function generateListeningOptions(correctWord, vocabulary) {
            const options = [correctWord];
            
            // æ·»åŠ æ··æ·†é€‰é¡¹
            while (options.length < 4) {
                const randomWord = vocabulary[Math.floor(Math.random() * vocabulary.length)];
                const randomWordText = randomWord.word;
                
                if (!options.includes(randomWordText) && randomWordText !== correctWord) {
                    options.push(randomWordText);
                }
            }
            
            // éšæœºæ’åºé€‰é¡¹
            return shuffleArray(options);
        }

        // éšæœºæ‰“ä¹±æ•°ç»„
        function shuffleArray(array) {
            const newArray = [...array];
            for (let i = newArray.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
            }
            return newArray;
        }

        // æ˜¾ç¤ºé—®é¢˜
        function showQuestion() {
            // ä»é—®é¢˜åº“ä¸­é€‰æ‹©ä¸€ä¸ªæœªé—®è¿‡çš„é—®é¢˜
            let availableQuestions = gameState.questions.filter(q => 
                !gameState.askedQuestions.includes(`${q.type}-${q.word}`)
            );
            
            // å¦‚æœæ‰€æœ‰é—®é¢˜éƒ½å·²é—®è¿‡ï¼Œé‡ç½®å·²é—®é—®é¢˜åˆ—è¡¨
            if (availableQuestions.length === 0) {
                gameState.askedQuestions = [];
                availableQuestions = gameState.questions;
            }
            
            // éšæœºé€‰æ‹©ä¸€ä¸ªé—®
            const randomIndex = Math.floor(Math.random() * availableQuestions.length);
            const question = availableQuestions[randomIndex];
            
            // è®°å½•å·²é—®é—®é¢˜
            gameState.askedQuestions.push(`${question.type}-${question.word}`);
            
            // å­˜å‚¨å½“å‰é—®é¢˜
            gameState.currentQuestion = question;
            
            // æ›´æ–°é—®é¢˜å¼¹çª—å†…å®¹
            document.getElementById('question-type').textContent = getQuestionTypeText(question.type);
            document.getElementById('question-text').textContent = question.question;
            
            // ç”Ÿæˆé€‰é¡¹
            const optionsContainer = document.getElementById('options-container');
            optionsContainer.innerHTML = '';
            
            question.options.forEach((option, index) => {
                const optionElement = document.createElement('div');
                optionElement.className = 'option';
                optionElement.textContent = `${String.fromCharCode(65 + index)}. ${option}`;
                optionElement.dataset.value = option;
                
                optionElement.addEventListener('click', function() {
                    checkAnswer(option, question);
                });
                
                optionsContainer.appendChild(optionElement);
            });
            
            // æ˜¾ç¤º/éšè—å¬åŠ›æŒ‰é’®
            const listenButton = document.getElementById('listen-word');
            if (question.type === 'listening') {
                listenButton.style.display = 'inline-block';
                // è‡ªåŠ¨æ’­æ”¾å•è¯å‘éŸ³
                setTimeout(() => {
                    speakText(question.word);
                }, 500);
            } else {
                listenButton.style.display = 'none';
            }
            
            // æ˜¾ç¤ºé—®é¢˜å¼¹çª—
            document.getElementById('question-modal').style.display = 'flex';
            
            // æœ—è¯»é¢˜ç›®
            speakQuestion(question);
            
            // å¦‚æœæ˜¯ç”µè„‘ç©å®¶ï¼Œè‡ªåŠ¨é€‰æ‹©ç­”æ¡ˆ
            if (gameState.players[gameState.currentPlayer].isComputer) {
                setTimeout(() => {
                    // ç”µè„‘æœ‰80%çš„æ¦‚ç‡ç­”å¯¹
                    const isCorrect = Math.random() < 0.8;
                    let selectedOption;
                    
                    if (isCorrect) {
                        selectedOption = question.correctAnswer;
                    } else {
                        // é€‰æ‹©ä¸€ä¸ªé”™è¯¯ç­”æ¡ˆ
                        const wrongOptions = question.options.filter(opt => opt !== question.correctAnswer);
                        selectedOption = wrongOptions[Math.floor(Math.random() * wrongOptions.length)];
                    }
                    
                    // æ¨¡æ‹Ÿç‚¹å‡»é€‰é¡¹
                    const optionElements = document.querySelectorAll('.option');
                    optionElements.forEach(opt => {
                        if (opt.dataset.value === selectedOption) {
                            opt.click();
                        }
                    });
                }, 2000);
            }
        }

        // è·å–é—®é¢˜ç±»å‹æ–‡æœ¬
        function getQuestionTypeText(type) {
            const typeMap = {
                'initial': 'å£°æ¯é—®é¢˜',
                'pinyin': 'æ‹¼éŸ³é—®é¢˜',
                'meaning': 'è¯ä¹‰é—®é¢˜',
                'listening': 'å¬åŠ›ç»ƒä¹ '
            };
            
            return typeMap[type] || 'é—®é¢˜';
        }

        // æœ—è¯»é—®é¢˜
        function speakQuestion(question) {
            let textToSpeak = question.question;
            
            if (question.type === 'listening') {
                // å¯¹äºå¬åŠ›é—®é¢˜ï¼Œå…ˆè¯»é—®é¢˜ï¼Œç„¶åè¯»å•è¯
                speakText(textToSpeak);
                setTimeout(() => {
                    speakText(question.word);
                }, 1500);
            } else {
                speakText(textToSpeak);
            }
        }

        // æ£€æŸ¥ç­”æ¡ˆ
        function checkAnswer(selectedOption, question) {
            const isCorrect = selectedOption === question.correctAnswer;
            const optionElements = document.querySelectorAll('.option');
            const currentPlayer = gameState.players[gameState.currentPlayer];
            
            // æ ‡è®°æ­£ç¡®å’Œé”™è¯¯ç­”æ¡ˆ
            optionElements.forEach(opt => {
                if (opt.dataset.value === question.correctAnswer) {
                    opt.classList.add('correct');
                } else if (opt.dataset.value === selectedOption && !isCorrect) {
                    opt.classList.add('incorrect');
                }
                
                // ç¦ç”¨æ‰€æœ‰é€‰é¡¹
                opt.style.pointerEvents = 'none';
            });
            
            // å¤„ç†é”™è¯¯ç­”æ¡ˆ
            if (!isCorrect) {
                // è®°å½•é”™è¯¯ç­”æ¡ˆ
                gameState.wrongAnswers.push({
                    question: question.question,
                    correctAnswer: question.correctAnswer,
                    playerAnswer: selectedOption,
                    word: question.word,
                    pinyin: question.pinyin,
                    meaning: question.meaning,
                    type: question.type,
                    timestamp: new Date().toLocaleString()
                });
                
                // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
                localStorage.setItem('wrongAnswers', JSON.stringify(gameState.wrongAnswers));
                
                // å°†ç©å®¶ä½ç½®é‡ç½®ä¸º0ï¼ˆè¿”å›èµ·ç‚¹ï¼‰
                currentPlayer.position = 0;
                
                // ç§»åŠ¨ç©å®¶å›¾æ ‡å›èµ·ç‚¹
                const playerElement = document.getElementById(`player-${currentPlayer.id}`);
                const startCell = document.getElementById(`cell-0`);
                const trackRect = document.getElementById('race-track').getBoundingClientRect();
                const cellRect = startCell.getBoundingClientRect();
                
                playerElement.style.left = `${cellRect.left - trackRect.left}px`;
                playerElement.style.top = `${cellRect.top - trackRect.top}px`;
                
                // æ›´æ–°ç©å®¶ä¿¡æ¯
                updatePlayersInfo();
            }
            
            // æœ—è¯»ç¡®è®¤
            speakText(isCorrect ? "ç­”æ¡ˆæ­£ç¡®ï¼" : "ç­”æ¡ˆé”™è¯¯ï¼");
            
            // å…³é—­é—®é¢˜å¼¹çª—å¹¶ç»§ç»­æ¸¸æˆ
            setTimeout(() => {
                document.getElementById('question-modal').style.display = 'none';
                nextTurn();
            }, 2000);
        }

        // ä¸‹ä¸€å›åˆ
        function nextTurn() {
            // åˆ‡æ¢åˆ°ä¸‹ä¸€ä¸ªç©å®¶
            gameState.currentPlayer = (gameState.currentPlayer + 1) % gameState.players.length;
            updatePlayersInfo();
            
            // å¯ç”¨æ·éª°å­æŒ‰é’®ï¼ˆå¦‚æœå½“å‰æ˜¯äººç±»ç©å®¶ï¼‰
            const currentPlayer = gameState.players[gameState.currentPlayer];
            const rollButton = document.getElementById('roll-dice');
            
            if (currentPlayer.isComputer) {
                rollButton.disabled = true;
                
                // ç”µè„‘ç©å®¶è‡ªåŠ¨æ·éª°å­
                setTimeout(() => {
                    rollDice();
                }, 1000);
            } else {
                rollButton.disabled = false;
            }
        }

        // ç»“æŸæ¸¸æˆ
        function endGame(winner) {
            gameState.isGameActive = false;
            
            // æ˜¾ç¤ºèƒœåˆ©æ¶ˆæ¯
            speakText(`æ­å–œ ${winner.name} èµ¢å¾—äº†æ¯”èµ›ï¼`);
            
            // åˆ›å»ºèƒœåˆ©åŠ¨ç”»
            createFireworks();
            
            // æ˜¾ç¤ºé‡æ–°å¼€å§‹æŒ‰é’®
            setTimeout(() => {
                alert(`${winner.name} èµ¢å¾—äº†æ¯”èµ›ï¼`);
                restartGame();
            }, 3000);
        }

        // åˆ›å»ºèƒœåˆ©åŠ¨ç”»
        function createFireworks() {
            const track = document.getElementById('race-track');
            
            for (let i = 0; i < 50; i++) {
                setTimeout(() => {
                    const firework = document.createElement('div');
                    firework.className = 'firework';
                    firework.style.left = `${Math.random() * 100}%`;
                    firework.style.top = `${Math.random() * 100}%`;
                    firework.style.backgroundColor = getRandomColor();
                    
                    // éšæœºè¿åŠ¨æ–¹å‘
                    const tx = (Math.random() - 0.5) * 200;
                    const ty = (Math.random() - 0.5) * 200;
                    firework.style.setProperty('--tx', `${tx}px`);
                    firework.style.setProperty('--ty', `${ty}px`);
                    
                    firework.style.animation = `explode 1s forwards`;
                    
                    track.appendChild(firework);
                    
                    // ç§»é™¤åŠ¨ç”»å…ƒç´ 
                    setTimeout(() => {
                        firework.remove();
                    }, 1000);
                }, i * 100);
            }
        }

        // è·å–éšæœºé¢œè‰²
        function getRandomColor() {
            const colors = ['#e74c3c', '#3498db', '#f39c12', '#2ecc71', '#9b59b6', '#1abc9c'];
            return colors[Math.floor(Math.random() * colors.length)];
        }

        // é‡æ–°å¼€å§‹æ¸¸æˆ
        function restartGame() {
            // é‡ç½®æ¸¸æˆçŠ¶æ€
            gameState.currentPlayer = 0;
            gameState.players.forEach(player => {
                player.position = 0;
            });
            gameState.isGameActive = true;
            gameState.askedQuestions = [];
            
            // é‡ç½®UI
            document.getElementById('main-menu').style.display = 'block';
            document.getElementById('game-area').style.display = 'none';
            document.getElementById('player-selection').style.display = 'none';
            document.getElementById('computer-selection').style.display = 'none';
            document.getElementById('difficulty-selection').style.display = 'none';
            document.getElementById('start-game').style.display = 'none';
            
            // é‡ç½®èµ›é“å’Œç©å®¶ä½ç½®
            createTrack();
            updatePlayersInfo();
            
            // å¯ç”¨æ·éª°å­æŒ‰é’®
            document.getElementById('roll-dice').disabled = false;
        }

        // æ˜¾ç¤ºé”™é¢˜æœ¬
        function showWrongAnswers() {
            const wrongAnswersList = document.getElementById('wrong-answers-list');
            wrongAnswersList.innerHTML = '';
            
            if (gameState.wrongAnswers.length === 0) {
                wrongAnswersList.innerHTML = '<p>è¿˜æ²¡æœ‰é”™é¢˜è®°å½•ã€‚</p>';
            } else {
                gameState.wrongAnswers.forEach((item, index) => {
                    const wrongAnswerItem = document.createElement('div');
                    wrongAnswerItem.className = 'wrong-answer-item';
                    
                    wrongAnswerItem.innerHTML = `
                        <h4>${item.question}</h4>
                        <p><strong>å•è¯:</strong> ${item.word} (${item.pinyin})</p>
                        <p><strong>ä½ çš„ç­”æ¡ˆ:</strong> ${item.playerAnswer}</p>
                        <p><strong>æ­£ç¡®ç­”æ¡ˆ:</strong> ${item.correctAnswer}</p>
                        <p><strong>æ—¶é—´:</strong> ${item.timestamp}</p>
                    `;
                    
                    wrongAnswersList.appendChild(wrongAnswerItem);
                });
            }
            
            document.getElementById('wrong-answers-modal').style.display = 'flex';
        }

        // åˆå§‹åŒ–è¯­éŸ³åˆæˆ
        function initializeSpeech() {
            if ('speechSynthesis' in window) {
                gameState.speechSupport = true;
                
                // è·å–å¯ç”¨è¯­éŸ³
                speechSynthesis.onvoiceschanged = function() {
                    gameState.voices = speechSynthesis.getVoices();
                    const voiceSelect = document.getElementById('voice-select');
                    
                    // æ¸…ç©ºé€‰é¡¹ï¼ˆé™¤äº†é»˜è®¤é€‰é¡¹ï¼‰
                    while (voiceSelect.options.length > 1) {
                        voiceSelect.remove(1);
                    }
                    
                    // æ·»åŠ ä¸­æ–‡è¯­éŸ³é€‰é¡¹
                    gameState.voices.forEach((voice, index) => {
                        if (voice.lang.startsWith('zh')) {
                            const option = document.createElement('option');
                            option.value = index;
                            option.textContent = `${voice.name} (${voice.lang})`;
                            voiceSelect.appendChild(option);
                        }
                    });
                };
                
                // ç«‹å³è·å–è¯­éŸ³ï¼ˆå¦‚æœå·²ç»åŠ è½½ï¼‰
                gameState.voices = speechSynthesis.getVoices();
                if (gameState.voices.length > 0) {
                    const voiceSelect = document.getElementById('voice-select');
                    
                    // æ¸…ç©ºé€‰é¡¹ï¼ˆé™¤äº†é»˜è®¤é€‰é¡¹ï¼‰
                    while (voiceSelect.options.length > 1) {
                        voiceSelect.remove(1);
                    }
                    
                    // æ·»åŠ ä¸­æ–‡è¯­éŸ³é€‰é¡¹
                    gameState.voices.forEach((voice, index) => {
                        if (voice.lang.startsWith('zh')) {
                            const option = document.createElement('option');
                            option.value = index;
                            option.textContent = `${voice.name} (${voice.lang})`;
                            voiceSelect.appendChild(option);
                        }
                    });
                }
            } else {
                alert('æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³åˆæˆåŠŸèƒ½ï¼Œéƒ¨åˆ†åŠŸèƒ½å¯èƒ½æ— æ³•ä½¿ç”¨ã€‚');
            }
        }

        // æœ—è¯»æ–‡æœ¬
        function speakText(text) {
            if (!gameState.speechSupport) return;
            
            // åœæ­¢å½“å‰è¯­éŸ³
            speechSynthesis.cancel();
            
            // åˆ›å»ºè¯­éŸ³å®ä¾‹
            const utterance = new SpeechSynthesisUtterance(text);
            
            // è®¾ç½®è¯­éŸ³å‚æ•°
            utterance.rate = gameState.rate;
            utterance.pitch = gameState.pitch;
            
            // è®¾ç½®è¯­éŸ³ï¼ˆå¦‚æœå·²é€‰æ‹©ï¼‰
            if (gameState.currentVoice) {
                utterance.voice = gameState.currentVoice;
            } else {
                // å°è¯•ä½¿ç”¨ä¸­æ–‡è¯­éŸ³
                const chineseVoices = gameState.voices.filter(voice => voice.lang.startsWith('zh'));
                if (chineseVoices.length > 0) {
                    utterance.voice = chineseVoices[0];
                }
            }
            
            // æœ—è¯»
            speechSynthesis.speak(utterance);
        }
    </script>
</body>
</html>